<dom-module id="dwr-app">
  <template>
    <style include="shared-styles"></style>
    <style>
      :host {
          display: block;
          height: 100%;
          position: relative;
      }

      .fullbleed {
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
      }

      h2 {
        font-weight: 200
      }

      paper-material {
        margin: 5px;
      }

      #locationBtn {
        display: none;
      }
    </style>

      <paper-header-panel  style="height:100%">
        <paper-toolbar slot="header">
          <div slot="top" style="flex:1">
          <div style="display:flex; align-items: center">

            <paper-icon-button 
              id="backToMapBtn" 
              icon="arrow-back" 
              on-click="_backToMap"
            ></paper-icon-button>

            <h2>Spatial CIMIS</h2>


            <div style="flex:1"></div>

              <paper-icon-button 
                id="locationBtn" 
                icon="maps:my-location" 
                on-click="_selectLocation">
              </paper-icon-button>

              <paper-menu-button horizontal-align="right">
                <paper-icon-button icon="more-vert" slot="dropdown-trigger" style="margin:0"></paper-icon-button>
                <paper-listbox 
                  slot="dropdown-content" 
                  id="mapLayerMenu" 
                  attr-for-selected="page" 
                  selected="{{selectedMenuItem}}">

                  <paper-item page="cimisGrid">
                    Explore Spatial CIMIS Grid
                  </paper-item>

                  <paper-item page="etoZones" disabled>
                    <paper-spinner id="etoSpinner" active ></paper-spinner>
                    Explore ETo Zones
                  </paper-item>

                  <paper-item page="dauZones" disabled>
                    <paper-spinner id="dauSpinner" active></paper-spinner>
                    Explore DAU Zones
                  </paper-item>

                  <paper-item page="about">About</paper-item>
                </paper-listbox>
              </paper-menu-button>
            </div>
          </div>
        </paper-toolbar>

        <iron-pages 
          class="fullbleed" 
          selected-attribute="active" 
          attr-for-selected="id" 
          selected="[[appState.section]]">
          
          <dwr-page-map id="map"></dwr-page-map>
          <dwr-page-data id="data"></dwr-page-data>
          <dwr-page-about id="about"></dwr-page-about>
          <dwr-page-location id="location"></dwr-page-location>
        </iron-pages>

      </paper-header-panel>

  </template>

  <script>
    class DwrApp extends Mixin(Polymer.Element)
        .with(EventMixin, AppStateMixin, DauMixin, EtoZonesMixin) {
      
      static get is() { return 'dwr-app'; }
  
      static get properties() {
        return {
          appState : {
            type : Object,
            value : function() {
              return {
                section : 'map'
              }
            }
          },
          selectedMenuItem : {
            type : String,
            value : '',
            observer : '_onMenuSelect'
          }
        }
      }
  
      ready() {
        super.ready();
        window.addEventListener('hashchange', this._setAppStateFromUrl.bind(this));
        this._setAppStateFromUrl();

        var loadingMsg = document.querySelector('#loading-init');
        if( loadingMsg ) document.body.removeChild(loadingMsg);
      }
  
      connectedCallback() {
        super.connectedCallback();
  
        if( window.standaloneMode ) {
          this.$.install.style.display = 'none';
        }
      }

      _onMenuSelect() {
        if( !this.selectedMenuItem ) return;

        switch(this.selectedMenuItem) {
          case 'cimisGrid':
            window.location.hash = 'map';
            break;
          case 'about':
            window.location.hash = 'about';
            break;
          default:
            this._setLayerFromMenu()
        }
      }
  
      _setAppStateFromUrl() {
        var parts = window.location.hash.replace(/#/,'').split('/');
        var state = {
          section : 'map'
        };
  
        if( parts.length > 0 && parts[0] ) {
          state.section = parts.splice(0, 1)[0];
        }
        if( parts.length > 0 && parts[0]) {
          if( state.section === 'map' || state.section === 'data' ) {
            state.mapState = parts.splice(0, 1)[0];
          }
        }
  
        if( parts.length > 0 && parts[0]) {
          state.extras = parts;
        }
  
        this._setAppState(state);
      }
  
      _onDauGeometryUpdate(e) {
        switch(e.state) {
          case 'loaded':
          this.shadowRoot.querySelector('[page="dauZones"]').removeAttribute('disabled');
            this.$.dauSpinner.removeAttribute('active');
            this.$.dauSpinner.style.display = 'none';
            break;
          case 'error':
            this.shadowRoot.querySelector('[page="dauZones"]').innerHTML = 'Failed to load Dau Zones :('
        }
      }
  
      _onEtoZonesGeometryUpdate(e) {
        switch(e.state) {
          case 'loaded':
            this.shadowRoot.querySelector('[page="etoZones"]').removeAttribute('disabled');
            this.$.etoSpinner.removeAttribute('active');
            this.$.etoSpinner.style.display = 'none';
            break;
          case 'error':
            this.shadowRoot.querySelector('[page="etoZones"]').innerHTML = 'Failed to load Dau Zones :('
        }
      }
  
      _onAppStateUpdate(e) {
        this.appState = e;
  
        if( this.appState.section === 'map' ) {
          this.$.locationBtn.style.display = 'block';
          this.$.backToMapBtn.style.display = 'none';
        } else {
          this.$.locationBtn.style.display = 'none';
          this.$.backToMapBtn.style.display = 'block';
        }
      }
  
  
      // getDate(index) {
      //   var d = new Date(new Date().getTime()-(86400000*(index+1)) );
  
      //   var y = d.getYear()+1900;
      //   var m = d.getMonth()+1;
      //   var d = d.getDate();
  
      //   if( m < 10 ) m = '0'+m;
      //   if( d < 10 ) d = '0'+d;
  
      //   return y+'-'+m+'-'+d;
      // }
  
      _setUrlStateFromMenu(e) {
        var newState = this.$.mapLayerMenu.selected;
        if( !newState || newState === this.appState.section ) {
          return;
        }
  
        window.location.hash = newState;
      }
  
      _setLayerFromMenu(e) {
        var newState = this.selectedMenuItem;
        if( !newState || newState === this.appState.mapState ) {
          return;
        }
  
        this._setAppState({mapState: newState});
  
        if( this.appState.section !== 'map' ) {
          window.location.hash = 'map';
        }
      }
  
      _selectLocation() {
        window.location.hash = 'location';
      }
  
      _backToMap() {
        window.location.hash = 'map';
      }
    }
  
    window.customElements.define(DwrApp.is, DwrApp);
  </script>
    
</dom-module>

