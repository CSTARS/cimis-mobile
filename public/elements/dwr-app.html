<dom-module id="dwr-app">
  <style>
    :host {
        display: block;
        height: 100%;
    }

    .menu a {
      display: block;
      text-align: left;
      padding-left: 0;
      padding-right: 0;
    }

    .menu td.link {
      border-bottom: #eee;
      padding: 15px;
    }

    .menu td.icon {
      vertical-align: top;
      padding: 15px;
      font-size: 24px;
      text-align: center;
    }

    .menu tr.active {
      background-color: #eee;
    }
    .menu tr.active .icon {
      color: #aaa;
    }

    .toggleButton {
      font-size: 22px;
    }

    .fullbleed {
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
    }

    paper-header-panel[main] {
      --paper-header-panel-shadow: {
          height: 6px;
          margin-top: -6px;
          box-shadow: 0 0 5px black;
      };
    }

    paper-header-panel[drawer] {
      --paper-header-panel-shadow: {
          height: 100%;
          bottom: 0px;
          box-shadow: 0 0 5px black;
      };
    }

    paper-material {
      margin: 5px;
    }
  </style>

  <template>

    <paper-drawer-panel id="drawer" responsive-width="768px">

      <paper-header-panel drawer class="drawer">
        <paper-toolbar style="background-color: #2196f3; z-index: 100">
          <h4 class="hidden-xs" style="margin:0; color:white">Spatial CIMIS [[appState.mapState]]</h4>
        </paper-toolbar>

        <div class="menu">
          <table style="width:100%" id="linktable">
            <tr>
              <td class="icon"><i class="fa fa-map-o"></i></td>
              <td class="link">
                <a class="btn btn-link btn-lg" href="#map" style="border-bottom:none">Map</a>
                <div id="exploreToggle">
                  <i class="fa fa-spinner fa-spin" id="zoneCheckboxLoading"></i>
                  <input type="checkbox" on-click="toggleExplore" layer="zone" id="zoneCheckbox" style="display:none" /> <span id="zoneCheckboxLabel">Loading</span> ETo Zones
                </div>
                <div id="exploreToggleDau">
                  <i class="fa fa-spinner fa-spin" id="dauCheckboxLoading"></i>
                  <input type="checkbox" on-click="toggleExplore" layer="dau" id="dauCheckbox" style="display:none" /> <span id="dauCheckboxLabel">Loading</span> DAU Zones
                </div>
              </td>
            </tr>

            <tr class="active">
              <td class="icon"><i class="fa fa-area-chart"></i></td>
              <td class="link"><a class="btn btn-link btn-lg" href="#data">Data</a></td>
            </tr>

            <tr>
              <td class="icon"><i class="fa fa-info-circle"></i></td>
              <td class="link"><a class="btn btn-link btn-lg" href="#about">About</a></td>
            </tr>

            <tr>
              <td class="icon"><i class="fa fa-mobile"></i></td>
              <td class="link"><a class="btn btn-link btn-lg" href="#about/install" id="install">Install on Mobile</a></td>
            </tr>
            <tr>
              <td class="icon"><i class="fa fa-edit"></i></td>
              <td class="link"><a class="btn btn-link btn-lg" href="#about/survey">Survey</a></td>
            </tr>
          </table>

        </div>

        <paper-menu 
          id="mainMenu" 
          selected="[[appState.section]]" 
          attr-for-selected="section" 
          selected-attribute="active"
          on-iron-select="_setSectionFromMenu">

          <paper-submenu section="map">
            <paper-item class="menu-trigger">Map</paper-item>
            <paper-material class="menu-content">

              <paper-menu 
                id="mapLayerMenu"
                selected="[[appState.mapState]]"
                attr-for-selected="layer" 
                selected-attribute="active"
                on-iron-select="_setLayerFromMenu">

                <paper-item layer="cimisGrid">Explore Spatial CIMIS Grid</paper-item>
                <paper-item layer="etoZones">Explore ETo Zones</paper-item>
                <paper-item layer="dauZones">Explore DAU Zones</paper-item>
              </paper-menu>
            </paper-material>
          </paper-submenu>
          <paper-item section="data">Data</paper-item>
          <paper-item section="about">About</paper-item>
        </paper-menu>
      </paper-header-panel>

      <paper-header-panel main>
        <paper-toolbar style="background-color: #2196f3; z-index: 100">
          <a class="btn btn-link" paper-drawer-toggle style="color:white"><i class="fa fa-bars" paper-drawer-toggle></i></a>

          <div class="visible-xs-inline-block">Spatial CIMIS</div>
          <div class="flex">
            <a class="btn btn-primary pull-right" on-click="selectLocation"><i class="fa fa-crosshairs"></i></a>
          </div>
        </paper-toolbar>

        <iron-pages class="fullbleed" id="pages" attr-for-selected="id" selected="[[appState.section]]">
          <dwr-page-map id="map" class="animated fadeIn" on-location-update="setLocation"></dwr-page-map>
          <dwr-page-data id="data" class="animated fadeIn" on-select-location="selectLocation"></dwr-page-data>
          <dwr-page-about id="about" class="animated fadeIn"></dwr-page-about>
        </iron-pages>

        <dwr-select-location id="selectLocation" on-location-select="onLocationSelected"></dwr-select-location>

      </paper-header-panel>
    </paper-drawer-panel>

  </template>
</dom-module>

<script>
  Polymer({
    is : 'dwr-app',

    properties: {
        appState: {
            type: Object,
            statePath: 'appState',
            observer : 'updatePage',
        }
    },

    actions : AppStateActions,

    behaviors: [ ReduxBehavior ],

    ready : function() {
      this.isReady = true;
      this.$.drawer.responsiveWidth = "768px";

      $(window).on('hashchange', this.setPage.bind(this));
      this.setPage();

      $.get('/eto_zones.json', function(data){
        CIMIS.zones.mergeZoneMap(data);
        this.$.map.setZoneData(data);
        this.$.zones.setZoneData(data);

        this.$.zoneCheckboxLoading.style.display = 'none';
        this.$.zoneCheckbox.style.display = 'inline-block';
        this.$.zoneCheckboxLabel.innerHTML = 'Explore';
      }.bind(this));

      $.get('/dauco.json', function(data){
        this.$.map.setDauData(data);
        this.$.dau.setDauData(data);

        this.$.dauCheckboxLoading.style.display = 'none';
        this.$.dauCheckbox.style.display = 'inline-block';
        this.$.dauCheckboxLabel.innerHTML = 'Explore';
      }.bind(this));
    },

    setPage : function() {
      var parts = window.location.hash.replace(/#/,'').split('/');
      var state = {}

      if( parts.length > 0 ) {
        state.section = parts.splice(0, 1);
      }
      if( parts.length > 0 ) {
        if( state.section === 'map' || state.section === 'data' ) {
          state.mapState = parts.splice(0, 1);
        }
      }
      if( parts.length > 0 ) {
        state.extras = parts;
      }

      this.dispatch('setAppState', state);

      this.$.drawer.closeDrawer();
    },

    attached : function() {
      this.$.selectLocation.init(this.$.map.map);
      if( window.standaloneMode ) {
        this.$.install.style.display = 'none';
      }
    },

    toggle : function() {
      this.$.drawer.togglePanel();
    },

    updatePage : function() {
      var hash = window.location.hash || '';
      var parts = hash.replace(/#/,'').split('/');
      this.page = parts.splice(0, 1)[0];

      if( !this.$[this.page] ) this.page = 'map';

      if( this.page == 'settings' || this.page == 'map' ) {
          this.showTabs = false;
      } else {
          this.showTabs = true;
      }

      $(this.$.linktable).find('tr').removeClass('active');
      $(this.$.linktable)
        .find('[href="'+hash+'"]')
        .parent().parent()
        .addClass('active');
      

      $(this.$.pages).children().hide();

      this.$[this.page].style.display = 'block'
      if( this.$[this.page].onShow  ) this.$[this.page].onShow(parts);

      this.$.drawer.closeDrawer();
    },

    setLocation : function(e) {
      // order data by date;
      /*var tmp = {};
      for( var i = 13; i >= 0; i-- ) {
        var d = this.getDate(i);
        var index = this.dates.indexOf(d);

        tmp[this.dates[index]] = this.getIndex(e.detail.data, index);
      }*/

      // this.$.data.render(e.detail);
    },

    getIndex : function(data, index) {
      if( data.length <= index ) return null;
      return data[index];
    },

    getDate : function(index) {
      var d = new Date(new Date().getTime()-(86400000*(index+1)) );

      var y = d.getYear()+1900;
      var m = d.getMonth()+1;
      var d = d.getDate();

      if( m < 10 ) m = '0'+m;
      if( d < 10 ) d = '0'+d;

      return y+'-'+m+'-'+d;
    },

    onLocationSelected : function(e) {
      this.$.map.setLocation(e.detail);
    },

    selectLocation : function() {
      this.$.selectLocation.show();
    },

    toggleExplore : function(e) {
      var layer = e.currentTarget.getAttribute('layer');

      if( layer === 'dau' ) this.querySelector('[layer="zone"]').checked = false;
      else this.querySelector('[layer="dau"]').checked = false;

      this.$.map.toggleExplore(e.currentTarget.checked, layer);
    },

    _setSectionFromMenu : function(e) {
      var newState = this.$.mainMenu.selected;
      if( !newState || newState === this.appState.section ) {
        return;
      }

      window.location.hash = newState;
    },

    _setLayerFromMenu : function(e) {
      var newState = this.$.mapLayerMenu.selected;
      if( !newState || newState === this.appState.mapState ) {
        return;
      }

      this.dispatch('setMapState', newState);
    }
  });
</script>
