<dom-module id="dwr-app">
  <style include="shared-styles"></style>
  <style>
    :host {
        display: block;
        height: 100%;
    }

    .fullbleed {
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
    }

    h3 {
      font-weight: 200
    }

    paper-material {
      margin: 5px;
    }

    #locationBtn {
      display: none;
    }
  </style>

  <template>

    <paper-drawer-panel id="drawer" responsive-width="768px">

      <paper-header-panel drawer class="drawer">
        <paper-toolbar>
          <h3>Spatial CIMIS</h3>
        </paper-toolbar>

        <paper-menu 
          id="mainMenu"
          selected="[[appState.section]]" 
          attr-for-selected="section" 
          selected-attribute="active">

          <paper-submenu section="map" id="submenu">
            <paper-item class="menu-trigger" on-click="_setUrlStateFromMenu">Map</paper-item>
            <paper-material class="menu-content">

              <paper-menu 
                id="mapLayerMenu"
                selected="[[appState.mapState]]"
                attr-for-selected="layer" 
                selected-attribute="active">

                <paper-item layer="cimisGrid" on-click="_setLayerFromMenu">
                  Explore Spatial CIMIS Grid
                </paper-item>
                <paper-item layer="etoZones" on-click="_setLayerFromMenu" disabled>
                  <paper-spinner id="etoSpinner" active ></paper-spinner>
                  Explore ETo Zones
                </paper-item>
                <paper-item layer="dauZones" on-click="_setLayerFromMenu" disabled>
                  <paper-spinner id="dauSpinner" active></paper-spinner>
                  Explore DAU Zones
                </paper-item>
              </paper-menu>
            </paper-material>
          </paper-submenu>
          <paper-item section="about" on-click="_setUrlStateFromMenu">About</paper-item>
        </paper-menu>
      </paper-header-panel>

      <paper-header-panel main>
        <paper-toolbar>
          <paper-icon-button paper-drawer-toggle icon="menu"></paper-icon-button>

          <div class="flex"></div>
          <div>
            <paper-icon-button id="locationBtn" icon="maps:my-location" on-click="_selectLocation"></paper-icon-button>
          </div>
        </paper-toolbar>

        <iron-pages 
          class="fullbleed" 
          selected-attribute="active" 
          attr-for-selected="id" 
          selected="[[appState.section]]">
          
          <dwr-page-map id="map"></dwr-page-map>
          <dwr-page-data id="data"></dwr-page-data>
          <dwr-page-about id="about"></dwr-page-about>
          <dwr-page-location id="location"></dwr-page-location>
        </iron-pages>

      </paper-header-panel>
    </paper-drawer-panel>

  </template>
</dom-module>

<script>
  Polymer({
    is : 'dwr-app',

    properties: {
        appState: {
            type: Object
        }
    },

    behaviors : [EventBusBehavior],

    ebBind : {
      'app-state-update' : '_onAppStateUpdate',
      'dau-geometry-update' : '_onDauLoad',
      'eto-zone-geometry-update' : '_onEtoLoad'
    },

    ready : function() {
      window.addEventListener('hashchange', this.setAppStateFromUrl.bind(this));
      this.setAppStateFromUrl();
    },

    setAppStateFromUrl : function() {
      var parts = window.location.hash.replace(/#/,'').split('/');
      var state = {}

      if( parts.length > 0 ) {
        state.section = parts.splice(0, 1)[0];
      }
      if( parts.length > 0 ) {
        if( state.section === 'map' || state.section === 'data' ) {
          state.mapState = parts.splice(0, 1)[0];
        }
      }

      if( parts.length > 0 ) {
        state.extras = parts;
      }

      this.getEventBus().emit('set-app-state', {state: state});
    },

    _onDauLoad : function(e) {
      switch(e.state) {
        case 'loaded':
          this.querySelector('[layer="dauZones"]').removeAttribute('disabled');
          this.$.dauSpinner.removeAttribute('active');
          this.$.dauSpinner.style.display = 'none';
          break;
        case 'error':
          this.querySelector('[layer="dauZones"]').innerHTML = 'Failed to load Dau Zones :('
      }
    },

    _onEtoLoad : function(e) {
      switch(e.state) {
        case 'loaded':
          this.querySelector('[layer="etoZones"]').removeAttribute('disabled');
          this.$.etoSpinner.removeAttribute('active');
          this.$.etoSpinner.style.display = 'none';
          break;
        case 'error':
          this.querySelector('[layer="etoZones"]').innerHTML = 'Failed to load Dau Zones :('
      }
    },

    _onAppStateUpdate : function(e) {
      this.appState = e;

      if( this.appState.section === 'map' ) {
        this.$.submenu.open();
        this.$.locationBtn.style.display = 'block';
      } else {
        this.$.submenu.close();
        this.$.locationBtn.style.display = 'none';
      }

      this.$.drawer.closeDrawer();
    },

    attached : function() {
      if( window.standaloneMode ) {
        this.$.install.style.display = 'none';
      }
    },

    getDate : function(index) {
      var d = new Date(new Date().getTime()-(86400000*(index+1)) );

      var y = d.getYear()+1900;
      var m = d.getMonth()+1;
      var d = d.getDate();

      if( m < 10 ) m = '0'+m;
      if( d < 10 ) d = '0'+d;

      return y+'-'+m+'-'+d;
    },

    _setUrlStateFromMenu : function(e) {
      var newState = this.$.mainMenu.selected;
      if( !newState || newState === this.appState.section ) {
        return;
      }

      window.location.hash = newState;
    },

    _setLayerFromMenu : function(e) {
      var newState = this.$.mapLayerMenu.selected;
      if( !newState || newState === this.appState.mapState ) {
        return;
      }

      this.getEventBus().emit('set-app-map-state', {state: newState});
    },

    _selectLocation : function() {
      window.location.hash = 'location';
    }
  });
</script>
