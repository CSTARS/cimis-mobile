<dom-module id="dwr-app">
  <style>
    :host {
        display: block;
        height: 100%;
    }

    .menu a {
      display: block;
      text-align: left;
      padding-left: 0;
      padding-right: 0;
    }

    .menu td.link {
      border-bottom: #eee;
      padding: 15px;
    }

    .menu td.icon {
      vertical-align: top;
      padding: 15px;
      font-size: 24px;
      text-align: center;
    }

    .menu tr.active {
      background-color: #eee;
    }
    .menu tr.active .icon {
      color: #aaa;
    }

    .toggleButton {
      font-size: 22px;
    }

    .fullbleed {
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
    }

    paper-header-panel[main] {
      --paper-header-panel-shadow: {
          height: 6px;
          margin-top: -6px;
          box-shadow: 0 0 5px black;
      };
    }

    paper-header-panel[drawer] {
      --paper-header-panel-shadow: {
          height: 100%;
          bottom: 0px;
          box-shadow: 0 0 5px black;
      };
    }

    paper-material {
      margin: 5px;
    }
  </style>

  <template>

    <paper-drawer-panel id="drawer" responsive-width="768px">

      <paper-header-panel drawer class="drawer">
        <paper-toolbar style="background-color: #2196f3; z-index: 100">
          <h4 class="hidden-xs" style="margin:0; color:white">Spatial CIMIS</h4>
        </paper-toolbar>

        <paper-menu 
          id="mainMenu"
          selected="[[appState.section]]" 
          attr-for-selected="section" 
          selected-attribute="active">

          <paper-submenu section="map" id="submenu">
            <paper-item class="menu-trigger" on-click="_setUrlStateFromMenu">Map</paper-item>
            <paper-material class="menu-content">

              <paper-menu 
                id="mapLayerMenu"
                selected="[[appState.mapState]]"
                attr-for-selected="layer" 
                selected-attribute="active">

                <paper-item layer="cimisGrid" on-click="_setLayerFromMenu">Explore Spatial CIMIS Grid</paper-item>
                <paper-item layer="etoZones" on-click="_setLayerFromMenu">Explore ETo Zones</paper-item>
                <paper-item layer="dauZones" on-click="_setLayerFromMenu">Explore DAU Zones</paper-item>
              </paper-menu>
            </paper-material>
          </paper-submenu>
          <paper-item section="about" on-click="_setUrlStateFromMenu">About</paper-item>
        </paper-menu>
      </paper-header-panel>

      <paper-header-panel main>
        <paper-toolbar style="background-color: #2196f3; z-index: 100">
          <a class="btn btn-link" paper-drawer-toggle style="color:white"><i class="fa fa-bars" paper-drawer-toggle></i></a>

          <div class="visible-xs-inline-block">Spatial CIMIS</div>
          <div class="flex">
            <a class="btn btn-primary pull-right" on-click="selectLocation"><i class="fa fa-crosshairs"></i></a>
          </div>
        </paper-toolbar>

        <iron-pages class="fullbleed" id="pages" selected-attribute="active" attr-for-selected="id" selected="[[appState.section]]">
          <dwr-page-map id="map" class="animated fadeIn" on-location-update="setLocation"></dwr-page-map>
          <dwr-page-data id="data" class="animated fadeIn" on-select-location="selectLocation"></dwr-page-data>
          <dwr-page-about id="about" class="animated fadeIn"></dwr-page-about>
        </iron-pages>

        <dwr-select-location id="selectLocation" on-location-select="onLocationSelected"></dwr-select-location>

      </paper-header-panel>
    </paper-drawer-panel>

  </template>
</dom-module>

<script>
  Polymer({
    is : 'dwr-app',

    properties: {
        appState: {
            type: Object
        }
    },

    behaviors : [EventBusBehavior],

    ebBind : {
      'app-state-update' : '_onAppStateUpdate'
    },

    ready : function() {
      $(window).on('hashchange', this.setAppStateFromUrl.bind(this));
      this.setAppStateFromUrl();
    },

    setAppStateFromUrl : function() {
      var parts = window.location.hash.replace(/#/,'').split('/');
      var state = {}

      if( parts.length > 0 ) {
        state.section = parts.splice(0, 1)[0];
      }
      if( parts.length > 0 ) {
        if( state.section === 'map' || state.section === 'data' ) {
          state.mapState = parts.splice(0, 1)[0];
        }
      }

      if( parts.length > 0 ) {
        state.extras = parts;
      }

      this.getEventBus().emit('set-app-state', {state: state});
    },

    _onAppStateUpdate : function(e) {
      this.appState = e;

      if( this.appState.section === 'map' ) {
        this.$.submenu.open();
      } else {
        this.$.submenu.close();
      }

      this.$.drawer.closeDrawer();
    },

    attached : function() {
      this.$.selectLocation.init(this.$.map.map);
      if( window.standaloneMode ) {
        this.$.install.style.display = 'none';
      }
    },

    getDate : function(index) {
      var d = new Date(new Date().getTime()-(86400000*(index+1)) );

      var y = d.getYear()+1900;
      var m = d.getMonth()+1;
      var d = d.getDate();

      if( m < 10 ) m = '0'+m;
      if( d < 10 ) d = '0'+d;

      return y+'-'+m+'-'+d;
    },

    _setUrlStateFromMenu : function(e) {
      var newState = this.$.mainMenu.selected;
      if( !newState || newState === this.appState.section ) {
        return;
      }

      window.location.hash = newState;
    },

    _setLayerFromMenu : function(e) {
      var newState = this.$.mapLayerMenu.selected;
      if( !newState || newState === this.appState.mapState ) {
        return;
      }

      this.getEventBus().emit('set-app-map-state', {state: state});
    }
  });
</script>
