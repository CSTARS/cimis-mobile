
<dom-module id="dwr-page-zones">
    <template>
        <style>
            :host {
                display: block;
            }
        </style>
        
        <div style="padding: 5%">
            <h4 class="page-header">
                <small>Eto Zone</small> <span>[[currentZone]]</span>  
                <a class="btn btn-link pull-right" href="#map">Back to Map</a>
            </h4>

            <div style="height:400px" id="zoneMap"></div>

            <div class="row">
                <div class="col-sm-offset-1">
                    <h4>Average: <span id="average" style="font-weight:bold"></span></h4>
                    <h4>Delta: <span id="delta" style="font-weight:bold"></span></h4>
                </div>
            </div>

            <div id="chart"></div>
            <div id="chart2"></div>
            <div id="chart3"></div>
        </div>

    </template>
    <script>
        Polymer({
            is: 'dwr-page-zones',

            ready : function() {
                this.currentZone = '';

                this.now = new Date();
                this.nowWeek = this.getWeekOfYear(0, this.now);

                this.months = ["Jan","Feb","Mar","Apr","May","June","July","Aug","Sept","Oct","Nov","Dec"];

                // this.styles = ["#3366cc","#dc3912","#ff9900","#109618","#990099","#0099c6",
                //     "#dd4477","#66aa00","#b82e2e","#316395","#994499","#22aa99",
                //     "#aaaa11","#6633cc","#e67300","#8b0707","#651067","#329262",
                //     "#5574a6","#3b3eac","#b77322","#16d620","#b91383","#f4359e",
                //     "#9c5935","#a9c413","#2a778d","#668d1c","#bea413","#0c5922","#743411"];

                var mapOptions = {
                    center: { lat: 38.033291, lng: -119.961762 },
                    zoom: 5,
                    mapTypeControl : false,
                    streetViewControl : false,
                    panControl : false
                };
                this.map = new google.maps.Map(this.$.zoneMap, mapOptions);
                this.map.data.addListener('click', this.onRegionClick.bind(this));

                $(window).on('resize', this.redraw.bind(this));
            },

            onRegionClick : function(e) {
                if( !e.feature ) {
                    return;
                }
                window.location.hash = '#zones/'+this.getRegionNumber(e.feature);
            },

            setZoneData : function(data) {
                this.map.data.addGeoJson(data);
                this.zoneDataSet = true;
                if( this.fireOnShow ) {
                    this.onShow([this.currentZone]);
                }
            },

            onShow : function(params) {
                if( params.length === 0 ) return;
                this.currentZone = params[0];

                if( !this.zoneDataSet ) {
                    this.fireOnShow = true;
                    return;
                }

                this.map.data.setStyle(function(feature) {
                    var label = this.getRegionNumber(feature);
                    if( label+'' === this.currentZone ){
                        return {
                            fillColor: CIMIS.zones.getZone(label).properties.color,
                            strokeColor: '#fff',
                            fillOpacity : .8,
                            strokeWeight: 1
                        };
                    } else {
                        return {
                            fillColor: '#333',
                            strokeColor: '#fff',
                            fillOpacity : .3,
                            strokeWeight: 1
                        };
                    }
                    
                }.bind(this));

                $.get('/cimis/region/Z'+this.currentZone, this.onZoneDataLoad.bind(this));

                if( !window.google ) return;
                google.maps.event.trigger(this.map, 'resize');
            },

            onZoneDataLoad : function(resp) {
                var data = CIMIS.zones.getZone(this.currentZone);
                this.$.average.innerHTML = data.properties.avg.toFixed(1);
                this.$.delta.innerHTML = data.properties.delta.toFixed(1);

                this.sortedDates = CIMIS.utils.sortDates(resp.data);

                var p = [data.properties.p0, data.properties.p1, data.properties.p2]; 
                var h = [0, data.properties.h1, data.properties.h2];
                var signature = CIMIS.fft.ifft(p, h, 52);


                var cumSignature = [], prev = 0;
                for( var i = 0; i < signature.length; i++ ) {
                    prev += signature[i]*7;
                    cumSignature.push(prev);
                }

                // eto chart
                this.dt = new google.visualization.DataTable();
                this.dt.addColumn('string', 'Date');
                this.dt.addColumn('number', 'Avg ETo');
                this.dt.addColumn('number', 'Expected ETo');

                var weeks = [this.getWeekOfYear(2), this.getWeekOfYear(1), this.getWeekOfYear(0)];

                var mid = Math.floor(this.sortedDates.length / 2);
                var end = this.sortedDates.length-1;

                this.sortedDates.forEach(function(date, index){
                    d = resp.data[date];
                    arr = [date];

                    arr.push(parseFloat(d) || 0);

                    if( index === 0 ) {
                        arr.push(signature[this.weekOffsetHelperCurrent(weeks[0])]);
                    } else if( index === mid ) {
                        arr.push(signature[this.weekOffsetHelperCurrent(weeks[1])]);
                    } else if( index === end ) {
                        arr.push(signature[this.weekOffsetHelperCurrent(weeks[2])]);
                    } else {
                        arr.push(null);
                    }

                    this.dt.addRow(arr);
                }.bind(this));

                if( !this.chart ) {
                    this.chart = new google.visualization.LineChart(this.$.chart);
                    this.options = {
                        title : 'ETo - Evapotranspiration (mm)',
                        curveType: 'function',
                        height : 550,
                        interpolateNulls : true,
                        animation : {
                            easing : 'out',
                            startup : true
                        },
                        series: {
                            1: { 
                                lineDashStyle: [4, 4] 
                            }
                        }
                    }
                }

                this.dt2 = new google.visualization.DataTable();
                this.dt2.addColumn('string', 'Week');
                this.dt2.addColumn('number', 'Eto');
                this.dt2.addColumn('number', 'Two Weeks Ago');
                this.dt2.addColumn('number', 'This Week');

                for( var i = 0; i < signature.length; i++ ) {
                    var actualWeek = this.getChartWeekLabel(i);
                    var arr = [actualWeek.label, signature[i]];
                    
                    if( actualWeek.week === weeks[0] ) {
                        arr.push(signature[i]);
                    } else {
                        arr.push(null);
                    }
                    if( actualWeek.week === weeks[2] ) {
                        arr.push(signature[i]);
                    } else {
                        arr.push(null);
                    }

                    this.dt2.addRow(arr);
                }

                if( !this.chart2 ) {
                    this.chart2 = new google.visualization.ComboChart(this.$.chart2);
                    this.options2 = {
                        title : 'Weekly Expected Evapotranspiration (mm)',
                        curveType: 'function',
                        height : 550,
                        legend : {
                            position : 'none'
                        },
                        hAxis : {
                            title : 'Week'
                        },
                        seriesType : 'bars',
                        series: {
                            0: { 
                                type : 'line',
                                targetAxisIndex : 0
                            }
                        }
                    }
                }

                this.dt3 = new google.visualization.DataTable();
                this.dt3.addColumn('string', 'Week');
                this.dt3.addColumn('number', 'Cumulative ETo');
                this.dt3.addColumn('number', 'Two Weeks Ago');
                this.dt3.addColumn('number', 'This Week');

                for( var i = 0; i < cumSignature.length; i++ ) {
                    var actualWeek = this.getChartWeekLabel(i);
                    var arr = [actualWeek.label, cumSignature[i]];
                    
                    if( actualWeek.week === weeks[0] ) {
                        arr.push(cumSignature[i]);
                    } else {
                        arr.push(null);
                    }
                    if( actualWeek.week === weeks[2] ) {
                        arr.push(cumSignature[i]);
                    } else {
                        arr.push(null);
                    }

                    this.dt3.addRow(arr);
                }

                if( !this.chart3 ) {
                    this.chart3 = new google.visualization.ComboChart(this.$.chart3);
                    this.options3 = {
                        title : 'Expected Cumulative Weekly Evapotranspiration (mm)',
                        curveType: 'function',
                        height : 550,
                        legend : {
                            position : 'none'
                        },
                        hAxis : {
                            title : 'Week'
                        },
                        seriesType : 'bars',
                        series: {
                            0: { 
                                type : 'line',
                                targetAxisIndex : 0
                            }
                        }
                    }
                }

                this.redraw();
            },

            redraw : function() {
                this.debounce('redraw',function(){
                    this.chart.draw(this.dt, this.options);
                    this.chart2.draw(this.dt2, this.options2);
                    this.chart3.draw(this.dt3, this.options3);
                });
            },

            getDayOfYear : function(offset, now) {
                var start = new Date(now.getFullYear(), 0, 0);
                var diff = now - start;
                var oneDay = 1000 * 60 * 60 * 24;
                var day = Math.ceil(diff / oneDay) - (offset || 0);
                if( day < 1 ) 356 + day;
                return day;
            },

            getWeekOfYear : function(offset, date) {
                if( !date ) date = new Date();
                return Math.floor(this.getDayOfYear(7*offset, date) / 7);
            },

            getRegionNumber : function(feature) {
                return feature.getProperty('zone');
                // return parseInt(feature.getProperty('Description').replace(/\D/g,''));
            },


            getDateOfWeek : function(w) {
                var y = this.now.getFullYear();
                
                if( this.nowWeek >= 40 ) {
                    if( w < 40 ) y++;
                } else {
                    if( w >= 40 ) y--;
                }

                var d = (1 + (w - 1) * 7); // 1st of January + 7 days for each week
                d = new Date(y, 0, d);

                return this.months[d.getMonth()]+' '+d.getDate()+', '+y;
            },

            getChartWeekLabel : function(w) {
                w = this.weekOffsetHelper(w);
                return {
                    week : w,
                    label : this.getDateOfWeek(w)
                }
            },

            weekOffsetHelper : function(w) {
                w = w-12;
                if( w < 0 ) w = w+52; 
                return w;
            },

            weekOffsetHelperCurrent : function(w) {
                w = w+12;
                if( w > 52 ) w = w-52; 
                return w;
            }
        });
    </script>
</dom-module>
