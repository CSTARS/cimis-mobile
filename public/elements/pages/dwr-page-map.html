<dom-module id="dwr-page-map">
  <style>
    :host {
      display: block;
      height: 100%;
    }
    #zoomTo {
      position: absolute;
      top: 25px;
      right: 10px;
    }
  </style>

  <template>
    <div id="map" style="height: 100%"></div>
    <div id="zoomTo" style="display:none">
      <a class="btn btn-default" on-click="zoomToGrid"><i class="fa fa-compress"></i></a>
    </div>
  </template>

</dom-module>

<script>
  Polymer({

    is : 'dwr-page-map',

    properties: {
      active : {
        type : Boolean,
        value : false,
        observer : '_onActive'
      },
      
      mapState: {
        type: String
      },
      
      dauGeometry: {
        type: Object,
        value : function() {
          return {state: 'loading'}
        }
      },
      etoGeometry: {
        type: Object,
        value : function() {
          return {state: 'loading'}
        }
      },

      dates: {
        type: Object
      },
      selectedCimisGrid : {
        type: String
      },
      selectedCimisGridData : {
        type : Object
      }
    },

    behaviors : [EventBusBehavior, AppUtils, CimisGridBehavior, EtoZoneBehavior],

    ebBind : {
      'cimis-grid-data-update' : '_onGridDataUpdate',
      'cimis-grid-dates-update' : '_onDatesLoad',
      'app-state-update' : '_onMapStateUpdate',
      'dau-geometry-update' : '_onDauLoad',
      'eto-zone-geometry-update' : '_onEtoLoad',
      'selected-location-update' : '_onLocationSelected'
    },

    ready : function() {
      this.first = true;

      this.latLng = new google.maps.LatLng(38.033291, -119.961762);
      var mapOptions = {
        center: { lat: 38.033291, lng: -119.961762 },
        zoom: 5,
        mapTypeControl : false,
        streetViewControl : false,
        panControl : false,
        zoomControlOptions : {
          style : 'LARGE'
        }
      };
      this.map = new google.maps.Map(this.$.map, mapOptions);

      this.map.data.setStyle({visible: false});

      google.maps.event.addListener(this.map, 'click', this._onMapClick.bind(this));
      this.map.data.addListener('click', this._onRegionClick.bind(this));

      this._loadDates();
    },

    _loadDates : function() {
      this.getEventBus().emit('get-cimis-grid-dates');
    },

    _onDauLoad : function(e) {
      this.dauGeometry = e;
      if( e.state === 'loaded' && this.mapState === 'dauZones' ) {
        this._onMapStateUpdate();
      }
    },

    _onEtoLoad : function(e) {
      this.etoGeometry = e;
      if( this.mapState === 'etoZones' ) {
        this._onMapStateUpdate();
      }
    },

    _onMapStateUpdate : function(e) {
      if( e ) {
        this.mapState = e.mapState;
      }

      if( !this.map ) return;

      // we only need to render a map state once
      if( this.renderedMapState === this.mapState ) return;

      // if we are showing etoZones and they are not loaded, return
      if( this.mapState === 'etoZones' && this.etoGeometry.state !== 'loaded' ) {
        return;
      }

      // if we are showing dauZones and they are not loaded, return
      if( this.mapState === 'dauZones' && this.dauGeometry.state !== 'loaded' ) {
        return;
      }

      this.debounce('_renderMapState', function(){
        this._renderMapState();
      }, 50);
    },

    _renderMapState : function() {

      this.map.data.forEach(function(feature) {
        this.map.data.remove(feature);
      }.bind(this));

      this.map.data.setStyle({visible: false});

      if( this.mapState === 'etoZones' || this.mapState === 'dauZones' ) {

        if( this.mapState === 'etoZones' ) this.map.data.addGeoJson(this.etoGeometry.data);
        else this.map.data.addGeoJson(this.dauGeometry.data);

        this.map.data.setStyle(function(feature) {
          if( this.mapState === 'dauZones' ) {
            return {
              fillColor: '#aaaaaa',
              strokeColor: '#ffffff',
              fillOpacity : .6,
              strokeWeight: 1
            };
          }

          var label = this.getRegionNumber(feature);

          return {
            fillColor: this.getZone(label).properties.color,
            strokeColor: '#ffffff',
            fillOpacity : .6,
            strokeWeight: 1
          };
        }.bind(this));

        this.clearCurrentGrid();
      } else {
        this.map.data.setStyle({visible: false});
      }

      this.renderedMapState = this.mapState;
    },

    getRegionNumber : function(feature) {
      var zone = feature.getProperty('zone');
      if( zone ) return zone;
      return feature.getProperty('dau_code');
    },

    _onRegionClick : function(e) {
      if( !e.feature ) {
        return;
      }

      this.latLng = e.latLng;

      if( e.feature.getProperty('dauco') ) {
        window.location.hash = '#data/'+this.mapState+'/'+this.getRegionNumber(e.feature);
      } else{
        window.location.hash = '#data/'+this.mapState+'/'+this.getRegionNumber(e.feature);
      }
    },

    _onMapClick : function(e){
      var storage = {
        latitude : e.latLng.lat(),
        longitude : e.latLng.lng()
      }

      if( window.localStorage ) {
        window.localStorage.setItem('cimis-location', JSON.stringify(storage));
      }

      this.latLng = e.latLng;
      this.grid = this.llToGrid(this.latLng);

      var id = this.grid.row+'-'+this.grid.col;
      this.renderGrid(this.grid.bottomLeft[1], this.grid.bottomLeft[0], 
                      this.grid.topRight[1], this.grid.topRight[0], id);

      this._selectGridId(id);
      this._loadGridData(id);
    },

    renderGrid : function(bottom, left, top, right, id) {
      this.bounds = new google.maps.LatLngBounds(
          new google.maps.LatLng(bottom, left),
          new google.maps.LatLng(top, right)
      );

      var polygon = [
        {lat: bottom, lng: left},
        {lat: top, lng: left},
        {lat: top, lng: right},
        {lat: bottom, lng: right},
        {lat: bottom, lng: left}
      ];

      this.clearCurrentGrid();


      this.rectangle = new google.maps.Polygon({paths: polygon});
      this.rectangle.setMap(this.map);

      this.overlay = new EtoOverlay(this.bounds, this.map);
      if( this.overlay.div_ ) {
        this.overlay.setValue('<iron-icon icon="cached" set-size></iron-icon>');
      }

      google.maps.event.addListener(this.rectangle, 'click', function(){
        window.location = '#data/cimisGrid/'+id;
      });
    },

    clearCurrentGrid : function() {
      if( this.rectangle ) this.rectangle.setMap(null);
      if( this.overlay ) this.overlay.setMap(null);
    },

    zoomToBounds : function() {
      if( !this.bounds ) return;
      this.map.fitBounds(this.bounds);
    },

    _onActive : function() {
      if( window.google ) {
        this.debounce('resizeMap', function(){
          google.maps.event.trigger(this.map, 'resize');
          this.map.setCenter(this.latLng);
        }, 50);
      }
    },

    _selectGridId : function(id) {
      this.getEventBus().emit('select-cimis-grid', {id: id});
    },

    _loadGridData : function(id) {
      this.getEventBus().emit('get-cimis-grid-data', {id: id, handler: this._onGridDataUpdate.bind(this)});
    },

    _onGridDataUpdate : function(e) {
      this.debounce('onGridDataUpdate', function() {
        this._onGridDataUpdateDelay(e);
      }, 50);
    },

    _onGridDataUpdateDelay : function(e) {
        if( e.state === 'loading' && this.overlay ) {
          return this.overlay.setValue('<iron-icon icon="cached" set-size></iron-icon>');
        }
        
        if( e.state !== 'loaded') return;

        this.selectedCimisGridData = e;

        this.ga('gridview', window.userType || 'unknown', this.selectedCimisGrid);

        var data = this.selectedCimisGridData.data;

        var html;
        if( data.data[this.yesterday] && data.data[this.yesterday].ETo !== undefined ) {
          html = '<div>'+data.data[this.yesterday].ETo.toFixed(1)+'</div><div>mm</div>';
        } else {
          return this.overlay.setValue('<iron-icon icon="error" set-size style="color: red"></iron-icon>');
        }

        if( !this.overlay ) {
          var id = data.location.row+'-'+data.location.col;
          var bounds = data.location.bounds;
          this.renderGrid(bounds[1][1], bounds[0][0], bounds[0][1], bounds[1][0]);
        }

        this.overlay.setValue(html);
    },

    // get the latest date
    _onDatesLoad : function(e) {
      if( e.state !== 'loaded' ) return;
      this.dates = e;

      dates = this.sortDates(this.dates.data);
      this.yesterday = dates[dates.length-1];
    },

    _onLocationSelected : function(location) {
      this.location = location;

      if( this.map ) {
        setTimeout(function(){
          this.map.setCenter({lat: location.latitude, lng: location.longitude});
        }.bind(this), 300);
      }
    },

    ga : function(name, type, value) {
      if( !window.ga ) return;
      ga('send', 'event', name, type, value, 1);
    }
  });
</script>
