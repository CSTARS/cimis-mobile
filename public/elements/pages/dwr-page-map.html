<dom-module id="dwr-page-map">
  <style>
    :host {
      display: block;
      height: 100%;
    }
    #zoomTo {
      position: absolute;
      top: 25px;
      right: 10px;
    }
  </style>

  <template>
    <div id="map" style="height: 100%"></div>
    <div id="zoomTo" style="display:none"><a class="btn btn-default" on-click="zoomToGrid"><i class="fa fa-compress"></i></a></div>
  </template>

</dom-module>

<script>
  Polymer({

    is : 'dwr-page-map',

    ready : function() {
      this.cache = {};
      this.first = true;

      this.regionsEnabled = false;

      var mapOptions = {
        center: { lat: 38.033291, lng: -119.961762 },
        zoom: 8,
        mapTypeControl : false,
        streetViewControl : false,
        panControl : false,
        zoomControlOptions : {
          style : 'LARGE'
        }
      };
      this.map = new google.maps.Map(this.$.map, mapOptions);

      this.map.data.setStyle({visible: false});

      google.maps.event.addListener(this.map, 'click', this.onMapClick.bind(this));
      this.map.data.addListener('click', this.onRegionClick.bind(this));

      $.get('/cimis/dates', this.onDatesLoad.bind(this));
    },

    setZoneData : function(data) {
      this.zoneData = data;
    },

    setDauData : function(data) {
      this.dauData = data;
    },

    toggleExplore : function(show, type) {
      this.map.data.forEach(function(feature) {
        this.map.data.remove(feature);
      }.bind(this));

      this.regionsEnabled = false;
      this.map.data.setStyle({visible: false});

      this.debounce('toggleExplore', function(){
        this._toggleExplore(show, type);
      }, 50);
    },

    _toggleExplore : function(show, type) {
      if( !type ) type = 'zone';

      if( show ) {
        if( type === 'zone' ) this.map.data.addGeoJson(this.zoneData);
        else this.map.data.addGeoJson(this.dauData);

        this.map.data.setStyle(function(feature) {
          if( type === 'dau' ) {
            return {
              fillColor: '#aaaaaa',
              strokeColor: '#ffffff',
              fillOpacity : .6,
              strokeWeight: 1
            };
          }

          var label = this.getRegionNumber(feature);

          return {
            fillColor: CIMIS.zones.getZone(label).properties.color,
            strokeColor: '#ffffff',
            fillOpacity : .6,
            strokeWeight: 1
          };
        }.bind(this));

        this.regionsEnabled = true;
        this.clearCurrentGrid();
      } else {
        this.regionsEnabled = false;
        this.map.data.setStyle({visible: false});
      }
    },

    getRegionNumber : function(feature) {
      var zone = feature.getProperty('zone');
      if( zone ) return zone;
      return feature.getProperty('dau_code');
      // return parseInt(feature.getProperty('Description').replace(/\D/g,''));
    },

    onRegionClick : function(e) {
      if( !e.feature ) {
        return;
      }
      if( e.feature.getProperty('dauco') ) {
        window.location.hash = '#dau/'+this.getRegionNumber(e.feature);
      } else{
        window.location.hash = '#zones/'+this.getRegionNumber(e.feature);
      }
    },

    onMapClick : function(e) {
      this.latLng = e.latLng;
      this.getData();
    },

    zoomToGrid : function() {
      if( !this.bounds ) return;
      this.map.fitBounds(this.bounds);
    },

    setLocation : function(e){
      if( window.localStorage ) {
        window.localStorage.setItem('cimis-location', JSON.stringify({
          latitude : e.latitude,
          longitude : e.longitude
        }));
      }

      this.latLng = new google.maps.LatLng(e.latitude, e.longitude);

      if( this.regionsEnabled ) {
        this.setGridAndBounds();
      } else {
        this.getData();
      }

      this.zoomToGrid();
    },

    clearCurrentGrid : function() {
      if( this.rectangle ) this.rectangle.setMap(null);
      if( this.overlay ) this.overlay.setMap(null);
    },

    setGridAndBounds : function() {
      this.grid = CIMIS.grid.llToGrid(this.latLng);
      this.cid = this.grid.row+'-'+this.grid.col;

      this.bounds = new google.maps.LatLngBounds(
          new google.maps.LatLng(this.grid.bottomLeft[1], this.grid.bottomLeft[0]),
          new google.maps.LatLng(this.grid.topRight[1], this.grid.topRight[0])
      );
    },

    getData : function() {
      this.$.zoomTo.style.display = 'block';

      this.setGridAndBounds();

      var polygon = [
        {lat: this.grid.bottomLeft[1], lng: this.grid.bottomLeft[0]},
        {lat: this.grid.topRight[1], lng: this.grid.bottomLeft[0]},
        {lat: this.grid.topRight[1], lng: this.grid.topRight[0]},
        {lat: this.grid.bottomLeft[1], lng: this.grid.topRight[0]},
        {lat: this.grid.bottomLeft[1], lng: this.grid.bottomLeft[0]}
      ]

      this.clearCurrentGrid();

      this.rectangle = new google.maps.Polygon({paths: polygon});
      this.rectangle.setMap(this.map);

      this.overlay = new EtoOverlay(this.bounds, this.map);

      google.maps.event.addListener(this.rectangle, 'click', function(){
        window.location = '#now';
      });

      if( this.cache[this.cid] ) {
        this.fireLocationUpdate();
      } else {
        this.overlay.setValue('<i class="fa fa-spinner fa-spin"></i>');
        $.get('/cimis/'+this.grid.row+'/'+this.grid.col, function(resp){
          this.cache[this.cid] = resp;
          this.fireLocationUpdate();
        }.bind(this));
      }
    },

    fireLocationUpdate : function() {
      var data = this.cache[this.cid];

      this.ga('gridview', window.userType || 'unknown', this.cid);

      var html;
      if( data.data[this.yesterday] && data.data[this.yesterday].ETo !== undefined ) {
        html = '<div>'+data.data[this.yesterday].ETo.toFixed(1)+'</div><div>mm</div>';
      } else {
        html = '<i class="fa fa-ban" style="color:red"></i>';
      }

      this.overlay.setValue(html);
      this.fire('location-update', data);
    },

    // get the latest date
    onDatesLoad : function(dates) {
      dates = CIMIS.utils.sortDates(dates);
      this.yesterday = dates[dates.length-1];
    },

    onShow : function() {
        if( !window.google ) return;
        google.maps.event.trigger(this.$.map, 'resize');

        if( this.first && this.latLng ) {
          this.first = false;
          this.zoomToGrid();
        }
    },

    ga : function(name, type, value) {
      if( !window.ga ) return;
      ga('send', 'event', name, type, value, 1);
    }
  });
</script>
