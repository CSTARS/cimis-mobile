
<dom-module id="dwr-page-dau">
    <template>
        <style>
            :host {
                display: block;
            }
        </style>
        
        <div style="padding: 5%">
            <h4 class="page-header">
                <small>DAU Zone</small> <span>[[currentZone]]</span>  
                <a class="btn btn-link pull-right" href="#map">Back to Map</a>
            </h4>

            <div style="height:400px" id="zoneMap"></div>

            <div id="chart"></div>
        </div>

    </template>
    <script>
        Polymer({
            is: 'dwr-page-dau',

            ready : function() {
                this.currentZone = '';

                var mapOptions = {
                    center: { lat: 38.033291, lng: -119.961762 },
                    zoom: 5,
                    mapTypeControl : false,
                    streetViewControl : false,
                    panControl : false
                };
                this.map = new google.maps.Map(this.$.zoneMap, mapOptions);
                this.map.data.addListener('click', this.onRegionClick.bind(this));

                $(window).on('resize', this.redraw.bind(this));
            },

            onRegionClick : function(e) {
                if( !e.feature ) {
                    return;
                }
                window.location.hash = '#dau/'+this.getRegionNumber(e.feature);
            },

            setDauData : function(data) {
                this.map.data.addGeoJson(data);
                this.zoneDataSet = true;
                if( this.fireOnShow ) {
                    this.onShow([this.currentZone]);
                }
            },

            onShow : function(params) {
                if( params.length === 0 ) return;
                this.currentZone = params[0];

                if( !this.zoneDataSet ) {
                    this.fireOnShow = true;
                    return;
                }

                this.map.data.setStyle(function(feature) {
                    var label = this.getRegionNumber(feature);
                    if( label+'' === this.currentZone ){
                        return {
                            fillColor: '#2196f3',
                            strokeColor: '#fff',
                            fillOpacity : .8,
                            strokeWeight: 1
                        };
                    } else {
                        return {
                            fillColor: '#333',
                            strokeColor: '#fff',
                            fillOpacity : .3,
                            strokeWeight: 1
                        };
                    }
                    
                }.bind(this));

                $.get('/cimis/region/DAU'+this.currentZone, this.onZoneDataLoad.bind(this));

                if( !window.google ) return;
                google.maps.event.trigger(this.map, 'resize');
            },

            onZoneDataLoad : function(resp) {
                this.sortedDates = CIMIS.utils.sortDates(resp.data);

                // eto chart
                this.dt = new google.visualization.DataTable();
                this.dt.addColumn('string', 'Date');
                this.dt.addColumn('number', 'Avg ETo');

                this.sortedDates.forEach(function(date, index){
                    d = resp.data[date];
                    arr = [date];

                    arr.push(parseFloat(d) || 0);

                    this.dt.addRow(arr);
                }.bind(this));

                if( !this.chart ) {
                    this.chart = new google.visualization.LineChart(this.$.chart);
                    this.options = {
                        title : 'ETo - Evapotranspiration (mm)',
                        curveType: 'function',
                        height : 550,
                        interpolateNulls : true,
                        animation : {
                            easing : 'out',
                            startup : true
                        }
                    }
                }

                this.redraw();
            },

            redraw : function() {
                this.debounce('redraw',function(){
                    this.chart.draw(this.dt, this.options);
                });
            },

            getRegionNumber : function(feature) {
              return feature.getProperty('dau_code');
            }
        });
    </script>
</dom-module>
