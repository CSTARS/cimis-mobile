<dom-module id="dwr-page-location">
  <style include="shared-styles"></style>
  <style>
    :host {
      display: block;
    }

    h1, h2 {
      font-weight: 200;
    }

    paper-material {
      padding: 15px;
      margin: 15px;
    }

    .history-item:hover {
      background: #f8f8f8;
    }

    .history-link:hover {
      font-weight: bold;
      cursor: pointer;
    }
  </style>

  <template>

    <h1>Set Location</h1>

    <paper-material>
      <h2>My Location</h2>
      <div>
        <paper-button raised on-click="geolocate" id="geolocate">
          <iron-icon icon="maps:my-location"></iron-icon>
          Geolocate
        </paper-button>
        <div id="geolocateMsg"></div>
      </div>

      <h2>Search</h2>
      <div>
        <paper-input type="text" id="inputSearch" label="Location name" on-keyup="onKeyPress" ></paper-input>

        <div state="loading">
          <span class="label label-success"><i class="fa fa-spinner fa-spin"></i> Searching</span>
        </div>
        <div state="error">
          Error loading geocoding results :(
        </div>
        <div state="loaded">
          <div id="noResults" style="display:none"></div>
          <template is="dom-repeat" items="[[results]]">
            <div><a index$="[[index]]" on-click="_onLocationSelect" style="cursor:pointer">[[item.address]]</a></div>
          </template>
        </div>
      </div>
    </paper-material>

    <paper-material>
      <h2>
        History

        <template is="dom-if" if="[[currentLocations.length]]">
          <paper-icon-button icon="close" on-click="_onHistoryDeleteAll" style="float:right"></paper-icon-button>
        </template>
      </h2>



      <template is="dom-if" if="[[!currentLocations.length]]">
        <div>Empty</div>
      </template>

      <template is="dom-repeat" items="[[currentLocations]]">
        <div class="layout center history-item">
          <div class="flex">
            <span class="history-link" on-click="_onHistorySelect" index$="[[index]]">[[item.address]]</span>
          </div>
          <div>
            <paper-icon-button icon="delete" on-click="_onHistoryDelete" index$="[[index]]"></paper-icon-button>
          </div>
        </div>
      </template>
    </paper-material>

  </template>
</dom-module>

<script>
  Polymer({
    is : 'dwr-page-location',

    properties : {
      results : {
        type : Array,
        value : function() {
          return [];
        }
      },
      currentLocations : {
        type : Array,
        value : function() {
          return [];
        }
      }
    },

    behaviors : [EventBusBehavior, StateToggleBehavior],

    ebBind : {
      'location-search-update' : '_onLocationSearch'
    },

    ready : function() {
      this.searchTimer = -1;
      this.set('currentLocations', this.load());
    },

    show : function() {
      this.renderCurrentLocations();
    },

    onKeyPress : function() {
      this.query = this.$.inputSearch.value;

      if( this.searchTimer != -1 ) clearTimeout(this.searchTimer);
      if( !this.query ) return;

      this.searchTimer = setTimeout(function(){
        this.query = this.$.inputSearch.value;
        this.searchTimer = -1;
        this.geocode();
      }.bind(this), 200);
    },

    geocode : function() {
      this.getEventBus().emit('search-location', {query: this.query})
    },

    _onLocationSearch: function(e) {
      this.toggleState(e.state);
      if( e.state !== 'loaded' ) return;

      var tmp = e.data.map(function(item){
                    return {
                      name : item.name,
                      address : item.formatted_address,
                      latitude : item.geometry.location.lat,
                      longitude : item.geometry.location.lng
                    }
                  });

      this.set('results', tmp);

      if( this.results.length == 0 ) {
        this.$.resultList.style.display = 'none';
        this.$.resultList.innerText = 'No resuls found for "'+this.query+'"';
        return;
      }

      this.$.resultList.style.display = 'block';
    },

    _onLocationSelect : function(e) {
      var index = parseInt(e.currentTarget.getAttribute('index'));

      this.getEventBus().emit('select-location', {location: this.results[index]});

      this.ga('data', 'location', 'select-searched');
      
      this._addToHistory(this.results[index]);

      this.$.inputSearch.value = '';
      this.set('results', []);
      window.location.hash = 'map';
    },

    _onHistorySelect : function(e) {
      var index = parseInt(e.currentTarget.getAttribute('index'));
      this.getEventBus().emit('select-location', {location: this.currentLocations[index]});

      this._addToHistory(this.currentLocations[index]);

      this.ga('data', 'location', 'select-history');

      window.location.hash = 'map';
    },

    _addToHistory : function(location) {
      var index = -1;
      for( var i = 0; i < this.currentLocations.length; i++ ) {
        if( this.currentLocations[i].address === location.address ) {
          index = i;
          break;
        }
      }

      if( index > -1 ) {
        this.currentLocations.splice(i, 1);
      }

      this.currentLocations.unshift(location);
      this.set('currentLocations', this.currentLocations.slice(0));
      this.save();
    },

    _onHistoryDeleteAll : function() {
      this.set('currentLocations', []);
      this.save();
    },

    _onHistoryDelete : function(e) {
      var index = parseInt(e.currentTarget.getAttribute('index'));
      this.currentLocations.splice(index, 1);
      this.set('currentLocations', this.currentLocations.slice(0));
      this.save();
    },

    save : function() {
      if( !window.localStorage ) return;
      window.localStorage.setItem('cimis-history', JSON.stringify(this.currentLocations));
    },

    load : function() {
      if( !window.localStorage ) return [];
      var history = window.localStorage.getItem('cimis-history');
      if( !history ) return [];
      return JSON.parse(history);
    },

    geolocate : function() {
      if( this.geolocating ) return;
      this.setLocating(true);

      if ( navigator.geolocation ) {
        navigator.geolocation.getCurrentPosition(this.onGeolocate.bind(this), this.onGeolocatError.bind(this));
      } else {
        this.setLocating(false);
        this.$.geolocateMsg.innerHTML = '<div class="text text-danger">Geolocation is not supported by this browser.  Sorry :(</div>';
      }
    },

    onGeolocate : function(position) {
      this.ga('data', 'location', 'geolocate');

      var event = {
        latitude : position.coords.latitude,
        longitude : position.coords.longitude,
        address : 'My Location'
      };

      this.getEventBus().emit('select-location', {location: event});
      window.location.hash = 'map';

      this.setLocating(false);
    },

    onGeolocatError : function(err) {
      this.ga('data', 'location', 'geolocate-error');
      this.$.geolocateMsg.innerHTML = '<div class="text text-danger">Geolocation Error. '+(err.message ? err.message : JSON.stringify(err))+'</div>';
      this.setLocating(false);
    },

    setLocating : function(locating) {
      this.geolocating = locating;
      if( locating ) {
        this.$.geolocateMsg.innerHTML = '';
        this.$.geolocate.setAttribute('disabled', '');
        this.$.geolocate.innerHTML = 'Geolocating...';
      } else {
        this.$.geolocate.removeAttribute('disabled');
        this.$.geolocate.innerHTML = 'Geolocate';
      }
    },

    ga : function(name, type, value) {
      if( !window.ga ) return;
      ga('send', 'event', name, type, value, 1);
    }

  })

</script>
