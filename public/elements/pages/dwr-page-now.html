<dom-module name="dwr-page-now">
  <template>
    <div id="warning" style="padding: 15px">
      <div class="text text-danger well" style="font-size: 20px"><i class="fa fa-warning"></i> Please select a location first</div>
    </div>

    <h4 class="page-header" id="gridLabel" style="display:none; margin: 0 10px"></h4>
    <div id="chartRoot"></div>
  </template>
</dom-module>

<script>
  Polymer({
    is : 'dwr-page-now',

    ready : function() {
      this.params = ['Rnl','Rso','U2', 'ETo', 'Tdew','Tn','Tx',];
      this.data = null;

      this.chartOptions = {
          title : '',
          height : 600,
          vAxes: [{
                  title: "Radiation Short/Long (MW/h); Wind Speed (m/s); Temperature Min/Max/Dew (^C);",
                  minValue : -5,
                  maxValue : 35
                },{
                  title: "ETo (mm)",
                  minValue : 0,
                  maxValue : 10
                }],
          hAxis: {title: "Date"},
          seriesType: "bars",
          series: {
              0: {type: "line", targetAxisIndex:0},
              1: {type: "line", targetAxisIndex:0},
              2: {type: "line", targetAxisIndex:0},
              3: {type: "area", targetAxisIndex:1}

          },
          legend : {
            maxLines : 3
          }
      }

      $(window).on('resize', this.redraw.bind(this));
    },

    createDataTable : function() {
        var dt = new google.visualization.DataTable();
        dt.addColumn('string', 'Date');

        for( var i = 0; i < this.params.length; i++ ) {
          var key = this.params[i];
          dt.addColumn('number', key+' ('+CIMIS.definitions[key].label+' '+CIMIS.definitions[key].units+')');
        }

        this.sortedDates.forEach(function(date){
          var d = this.data.data[date];

          var arr = [date];
          for( var i = 0; i < this.params.length; i++ ) {
            arr.push(d[this.params[i]] || 0);
          }

          dt.addRow(arr);
        }.bind(this));

        return dt;
    },

    render : function(data) {
      if( this.data == null ) {
        this.$.warning.innerHTML = '';
        this.$.gridLabel.style.display = 'block';
      }
      //if( !this.selected ) {
      //  this.firstRender();
      //}

      if( data ) {
        this.data = data;
        this.sortedDates = CIMIS.utils.sortDates(data.data);
        this.$.gridLabel.innerHTML = 'Cell: '+data.location.row+', '+data.location.col +
          ' <a class="pull-right" href="/cimis/'+data.location.row+'/'+data.location.col+
          '" target="_blank">API</a>';
      }

      if( !this.chart ) {
        this.chart = new google.visualization.ComboChart(this.$.chartRoot);
        /*this.options = {
            legend : {
                position : 'none'
            },
            animation: {
              duration: 700,
              easing: 'out',
            },
            height: 400,
            interpolateNulls : true
        };*/
      }


      //this.dt = google.visualization.arrayToDataTable(this.paramToArray(this.selected, this.data.data));
      this.dt = this.createDataTable();

      this.chart.draw(this.dt, this.chartOptions);
    },

    firstRender : function() {
      this.selected = this.params[0];

      var html =
        '<div class="form-horizontal">' +
          '<div class="form-group">'+
            '<label class="col-sm-2 control-label">Parameter</label>'+
            '<div class="col-sm-10">'+
              '<select class="form-control">';

      for( var i = 0; i < this.params.length; i++ ) {
        html += '<option value="'+this.params[i]+'">'+this.params[i]+'</option>';
      }
      html += '</select></div></div>';

      html +=
      '<div class="form-group">'+
        '<label class="col-sm-2 control-label">CIMIS Grid</label>'+
        '<div class="col-sm-10">'+
          '<div id="grid-label"></div>'+
        '</div>'+
      '</div></div>'+
      '<div id="chart-root"></div>';
      var ele = $(this.$.root).html(html);

      ele.find('select').on('change', function(e){
        this.selected = $(e.currentTarget).val();
        this.render();
      }.bind(this));

      this.chartRoot = ele.find('#chart-root');
      this.gridLabel = ele.find('#grid-label');
    },

    onShow : function(){
      this.redraw();
    },

    redraw : function() {
      if( !this.chart ) return;
      this.chart.draw(this.dt, this.chartOptions);
    },

    renderParam : function(param, data) {
      var html = '<h4 class="page-header">'+param+'</h4>';
      html += '<div class="row"><div class="col-md-6"><table class="table">';

      this.sortedDates.forEach(function(date){
        html += '<tr><td>'+date+'</td><td>'+(data[date][param] !== undefined ? data[date][param] : 'N/A')+'</td></tr>';
      });
      html += '</table></div><div class="col-md-6"><div id="'+param+'-chart" style="height: 500px"></div></div></div>';
      return html;
    },

    paramToArray : function(param, data) {
      var array = [['Date', param]];

      if( Object.keys(data).length === 0 ) {
        array.push(['no data', 0]);
        return array;
      }

      this.sortedDates.forEach(function(date){
        array.push([date, data[date][param]]);
      });

      return array;
    },

  })
</script>
