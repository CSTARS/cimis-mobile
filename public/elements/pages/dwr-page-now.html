<dom-module name="dwr-page-now">
  <style>
    .chart:first-child {
      margin-top: 50px;
    }
    .chart {
      margin: 100px 25px 0 25px;
    }
    @media(max-width: 768px) {
      .chart {
        margin: 75px 10px 0 10px;
      }
    }
  </style>

  <template>
    <div id="warning" style="padding: 15px">
      <div class="text text-danger well" style="font-size: 20px"><i class="fa fa-warning"></i> You must select a location first.</div>

      <div style="text-align:center">
        <a class="btn btn-default btn-lg" on-click="setLocation"><i class="fa fa-crosshairs"></i> Set Location</a>
      </div>
    </div>

    <h4 class="page-header" id="gridLabel" style="display:none; margin: 0 10px"></h4>
    <div id="docs" style="margin: 0 10px; display:none; text-align:right"><a href="#about/api"><i class="fa fa-book"></i> API Documentation</a></div>

    <div id="charts" style="margin: 0 -25px"></div>
    <div id="chartRoot"></div>
  </template>
</dom-module>

<script>
  Polymer({
    is : 'dwr-page-now',

    ready : function() {
      this.params = ['Rnl','Rso','U2', 'ETo', 'Tdew','Tn','Tx',];
      this.data = null;

      this.chartOptions = {
          title : '',
          height : 600,
          vAxes: [{
                  title: "Radiation Short/Long (MW/h); Wind Speed (m/s); Temperature Min/Max/Dew (^C);",
                  minValue : -5,
                  maxValue : 35
                },{
                  title: "ETo (mm)",
                  minValue : 0,
                  maxValue : 10
                }],
          hAxis: {title: "Date"},
          seriesType: "bars",
          series: {
              0: {type: "line", targetAxisIndex:0},
              1: {type: "line", targetAxisIndex:0},
              2: {type: "line", targetAxisIndex:0},
              3: {type: "area", targetAxisIndex:1}

          },
          legend : {
            maxLines : 3
          }
      }

      this.options = [
        {
          //chart : {
            title : 'ETo - Evapotranspiration (mm)',
          //},
          height : 550,
          legend : {
            position : 'none'
          }
        },
        {
          //chart : {
            title : 'Temperature Min/Max/Dew (^C)',
          //},
          height : 550,
          legend : {
            position : 'none'
          }
        },
        {
          //chart : {
            title : 'Radiation Short/Long (MW/h)',
          //},
          height : 550,
          legend : {
            position : 'none'
          }
        },
        {
          //chart : {
            title : 'Wind Speed (m/s)',
          //},
          height : 550,
          legend : {
            position : 'none'
          }
        }
      ];

      this.charts = null;
      this.datatables = [];
      this.resize();

      $(window).on('resize', function(){
        this.resize();
        this.redraw();
      }.bind(this));
    },

    resize : function(){
      var size = 550;
      if( $(window).width() < 768 ) {
        size = 450;
      }

      for( var i = 0; i < this.options.length; i++ ) {
        this.options[i].height = size;
      }
    },

    createDataTables : function() {
      this.datatables = [];
      var d, arr;

      // eto chart
      dt = new google.visualization.DataTable();
      dt.addColumn('string', 'Date');
      dt.addColumn('number', 'ETo');

      this.sortedDates.forEach(function(date){
        d = this.data.data[date];
        arr = [date];

        arr.push(d.ETo || 0);

        dt.addRow(arr);
      }.bind(this));

      this.datatables.push(dt);

      // temp chart
      dt = new google.visualization.DataTable();
      dt.addColumn('string', 'Date');
      dt.addColumn('number', 'Dewpoint Temperature');
      dt.addColumn('number', 'Max Temperature');
      dt.addColumn('number', 'Min Temperature');

      this.sortedDates.forEach(function(date){
        d = this.data.data[date];
        arr = [date];

        arr.push(d.Tdew || 0);
        arr.push(d.Tx || 0);
        arr.push(d.Tn || 0);

        dt.addRow(arr);
      }.bind(this));

      this.datatables.push(dt);

      // Radiation chart
      dt = new google.visualization.DataTable();
      dt.addColumn('string', 'Date');
      dt.addColumn('number', 'Longwave Radiation');
      dt.addColumn('number', 'Shortwave Radiation');

      this.sortedDates.forEach(function(date){
        d = this.data.data[date];
        arr = [date];

        arr.push(d.Rnl || 0);
        arr.push(d.Rso || 0);

        dt.addRow(arr);
      }.bind(this));

      this.datatables.push(dt);

      // wind speed chart
      dt = new google.visualization.DataTable();
      dt.addColumn('string', 'Date');
      dt.addColumn('number', 'Wind Speed');


      this.sortedDates.forEach(function(date){
        d = this.data.data[date];
        arr = [date];

        arr.push(d.U2 || 0);

        dt.addRow(arr);
      }.bind(this));

      this.datatables.push(dt);
    },

    render : function(data) {
      if( this.data == null ) {
        this.$.warning.innerHTML = '';
        this.$.gridLabel.style.display = 'block';
        this.$.docs.style.display = 'block';
      }


      if( data ) {
        this.data = data;
        this.sortedDates = CIMIS.utils.sortDates(data.data);
        this.$.gridLabel.innerHTML = '<i class="fa fa-map-marker"></i> Cell: '+data.location.row+', '+data.location.col +
          ' <a class="pull-right" href="/cimis/'+data.location.row+'/'+data.location.col+
          '" target="_blank">API</a>';
      }

      this.createDataTables();

      if( !this.charts ) {
        this.charts = [];
        this.$.charts.innerHTML = '';

        for( var i = 0; i < this.datatables.length; i++ ) {
          var root = document.createElement('div');
          root.className = 'chart style-scope dwr-page-now';
          this.$.charts.appendChild(root);
          //this.charts.push(new google.charts.Line(root));
          this.charts.push(new google.visualization.LineChart(root));
        }
      }

      for( var i = 0; i < this.datatables.length; i++ ) {
        this.charts[i].draw(this.datatables[i], this.options[i]);
      }
    },

    onShow : function(){
      this.redraw();
    },

    redraw : function() {
      if( !this.charts ) return;

      for( var i = 0; i < this.datatables.length; i++ ) {
        this.charts[i].draw(this.datatables[i], this.options[i]);
      }
    },

    setLocation : function() {
      this.fire('select-location');
    }

  })
</script>
