<dom-module name="dwr-page-now">
  <template>
    <div id="root" style="padding: 15px">
      <div class="text text-danger well" style="font-size: 20px"><i class="fa fa-warning"></i> Please select a location first</div>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is : 'dwr-page-now',

    ready : function() {
      this.params = ['ETo','K','Rnl','Rso','Tdew','Tn','Tx','U2'];
      this.selected = null;

      $(window).on('resize', this.redraw.bind(this));
    },

    render : function(data) {
      if( !this.selected ) {
        this.firstRender();
        //this.chartRoot.html(this.renderParam(this.selected, this.data.data));
      }

      if( data ) {
        this.data = data;
        this.sortedDates = this.sortDates(data.data);
        this.gridLabel.html('<a class="btn btn-link" href="/cimis/'+data.location.row+'/'+data.location.col+
          '" target="_blank"><i class="fa fa-link"></i> '+data.location.row+', '+data.location.col+'</a>');
      }

      if( !this.chart ) {
        this.chart = new google.visualization.LineChart(this.chartRoot[0]);
        this.options = {
            legend : {
                position : 'none'
            },
            animation: {
              duration: 700,
              easing: 'out',
            },
            height: 400,
            interpolateNulls : true
        };
      }

      // todo fix height for size


      this.dt = google.visualization.arrayToDataTable(this.paramToArray(this.selected, this.data.data));
      this.chart.draw(this.dt, this.options);
    },

    firstRender : function() {
      this.selected = this.params[0];

      var html =
        '<div class="form-horizontal">' +
          '<div class="form-group">'+
            '<label class="col-sm-2 control-label">Parameter</label>'+
            '<div class="col-sm-10">'+
              '<select class="form-control">';

      for( var i = 0; i < this.params.length; i++ ) {
        html += '<option value="'+this.params[i]+'">'+this.params[i]+'</option>';
      }
      html += '</select></div></div>';

      html +=
      '<div class="form-group">'+
        '<label class="col-sm-2 control-label">CIMIS Grid</label>'+
        '<div class="col-sm-10">'+
          '<div id="grid-label"></div>'+
        '</div>'+
      '</div></div>'+
      '<div id="chart-root"></div>';
      var ele = $(this.$.root).html(html);

      ele.find('select').on('change', function(e){
        this.selected = $(e.currentTarget).val();
        this.render();
      }.bind(this));

      this.chartRoot = ele.find('#chart-root');
      this.gridLabel = ele.find('#grid-label');
    },

    sortDates : function(data) {
      var arr = [];
      for( var date in data ) {
        arr.push({
          str : date,
          time : new Date(date).getTime()
        });
      }

      arr.sort(function(a, b){
        if( a.time > b.time ) return 1;
        if( b.time < a.time ) return -1;
        return 0;
      });

      var tmp = [];
      arr.forEach(function(item){
        tmp.push(item.str);
      });

      return tmp;
    },

    onShow : function(){
      this.redraw();
    },

    redraw : function() {
      if( !this.chart ) return;
      this.chart.draw(this.dt, this.options);
    },

    renderParam : function(param, data) {
      var html = '<h4 class="page-header">'+param+'</h4>';
      html += '<div class="row"><div class="col-md-6"><table class="table">';

      this.sortedDates.forEach(function(date){
        html += '<tr><td>'+date+'</td><td>'+(data[date][param] !== undefined ? data[date][param] : 'N/A')+'</td></tr>';
      });
      html += '</table></div><div class="col-md-6"><div id="'+param+'-chart" style="height: 500px"></div></div></div>';
      return html;
    },

    paramToArray : function(param, data) {
      var array = [['Date', param]];

      if( Object.keys(data).length === 0 ) {
        array.push(['no data', 0]);
        return array;
      }

      this.sortedDates.forEach(function(date){
        array.push([date, data[date][param]]);
      });

      console.log(data);
      console.log(array);

      return array;
    },

  })
</script>
