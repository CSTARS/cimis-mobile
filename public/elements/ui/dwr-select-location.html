<dom-module id="dwr-select-location">
  <style>
    :host {
      display: block;
    }
  </style>

  <template>

    <div class="modal fade" id="popup">
      <div class="modal-dialog">
        <div class="modal-content">

          <div class="modal-header" id="header">
            <button type="button" class="close" data-dismiss="modal">
              <span aria-hidden="true">&times;</span>
              <span class="sr-only">Close</span></button>

            <h4 class="modal-title">Set Location</h4>
          </div>

          <div class="modal-body" id="body">

            <div class="form-horizontal">
                <div class="form-group">
                    <label for="inputSearch" class="col-sm-2 control-label">Search</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" id="inputSearch" placeholder="Location name" on-keyup="onKeyPress" />
                    </div>
                </div>
            </div>

            <div id="searchingLabel" style="display:none">
              <span class="label label-success"><i class="fa fa-spinner fa-spin"></i> Searching</span>
            </div>

            <div id="resultList"></div>

            <h4 style="margin-top:30px">Saved Locations</h4>
            <div id="savedLocationsTable"></div>
          </div> <!-- end body -->

          <div class="modal-footer" id="footer">

          </div>


        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is : 'dwr-select-location',

    ready : function() {
      this.searchTimer = -1;
      this.currentLocations = JSON.parse(window.localStorage.getItem('currentLocations'));
      if( !this.currentLocations ) this.currentLocations = [];

      this.queryBounds = new google.maps.LatLngBounds(
          new google.maps.LatLng(31.116463, -125.649703),
          new google.maps.LatLng(42.279745, -113.838212)
      );

      $(this.$.popup).modal({show: false}); // init modal
    },

    init : function(map) {
      this.map = map;
      this.places = new google.maps.places.PlacesService(this.map);
      this.geocoder = new google.maps.Geocoder();
    },

    show : function() {
      this.renderCurrentLocations();
      $(this.$.popup).modal('show');
    },

    onKeyPress : function() {
      this.query = $(this.$.inputSearch).val();

      if( this.searchTimer != -1 ) clearTimeout(this.searchTimer);
      if( !this.query ) return;

      this.searchTimer = setTimeout(function(){
        this.query = $(this.$.inputSearch).val();
        this.searchTimer = -1;
        this.geocode();
      }.bind(this), 200);

      //this.places.textSearch({query: this.query, bounds: this.queryBounds}, this.gotResults.bind(this));


    },

    geocode : function() {
      console.log(this.queryBounds);
      this.geocoder.geocode({ 'address': this.query+' California', bounds: this.queryBounds}, this.geocodeResults.bind(this));
    },

    geocodeResults : function(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
        this.gotResults(results);
      } else {
        alert("Geocode was not successful for the following reason: " + status);
      }
    },

    gotResults: function(results) {
      this.results = [];

      for( var i = 0; i < results.length; i++ ) {
        this.results.push({
          name : results[i].name,
          address : results[i].formatted_address,
          latitude: results[i].geometry.location.lat(),
          longitude: results[i].geometry.location.lng(),
        });
      }

      if( this.results.length == 0 ) {
        this.$.resultList.innerText = 'No resuls found for "'+this.query+'"';
        return;
      }

      var list = '<ul style="list-style:none">';
      for( var i = 0; i < this.results.length; i++ ) {
        var result = this.results[i];
        list += '<li index="'+i+'"><a>'+result.address+'</a></li>';
      }
      this.$.resultList.innerHTML = list+'</ul>';
    },

    renderCurrentLocations : function() {
      if( this.currentLocations.length == 0 ) {
        this.$.savedLocationsTable.innerText = 'None';
        return;
      }

      var table = '<table class="table">';
      for( var i = 0; i < this.currentLocations.length; i++ ) {
        var l = this.currentLocations[i];

        table += '<tr '+(l.selected ? 'selected' : '')+'>'+
                '<td style="white-space:nowrap">'+
                    '<input type="checkbox" '+(l.selected ? 'checked' : '')+' index="'+i+'" />'+
                    (l.selected ? 'Selected' : '')+
                '</td>'+
                '<td>'+
                    '<img src="'+l.icon+'" /> '+loc.name+' - '+loc.address+
                '</td>'+
                '<td>'+
                    '<a class="btn btn-link" index="'+i+'" ><i class="fa fa-trash"></i></a>'+
                '</td>'+
            '</tr>';
      }
      this.$.savedLocationsTable.innerHTML = table+'</table>';
    }

  })

</script>





<!--
<link rel="import" href="dwr-select-location-popup.html">

<polymer-element name="dwr-select-location" attributes="map location">
    <template>

        <a on-click="{{select}}" class="btn {{location ? 'btn-success' : 'btn-default'}}" style="margin: -5px 0 -5px 15px">
            <core-icon icon="maps:place"></core-icon>
            <span hidden?="{{location}}">
                Select Location
            </span>
            <span hidden?="{{!location}}">
                {{location.name}}
            </span>
        </a>

        <dwr-select-location-popup id="popup" map="{{map}}" selectedLocation="{{location}}" ></dwr-select-location-popup>

    </template>
    <script>
        Polymer('dwr-select-location', {
            location : null,

            select : function(){
                this.$.popup.show();
            }
        });
    </script>
</polymer-element>
-->
