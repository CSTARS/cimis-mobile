<dom-module id="dwr-select-location">
  <style>
    :host {
      display: block;
    }
  </style>

  <template>

    <div class="modal fade" id="popup">
      <div class="modal-dialog">
        <div class="modal-content">

          <div class="modal-header" id="header">
            <button type="button" class="close" data-dismiss="modal">
              <span aria-hidden="true">&times;</span>
              <span class="sr-only">Close</span></button>

            <h4 class="modal-title">Set Location</h4>
          </div>

          <div class="modal-body" id="body">

            <div class="form-horizontal">
                <div class="form-group">
                    <label for="inputSearch" class="col-sm-3 control-label">My Location</label>
                    <div class="col-sm-9">
                        <a class="btn btn-primary" on-click="geolocate" id="geolocate"><i class="fa fa-crosshairs"></i> Geolocate</a>
                    </div>
                </div>
            </div>

            <div class="form-horizontal">
                <div class="form-group">
                    <label for="inputSearch" class="col-sm-3 control-label">Search</label>
                    <div class="col-sm-9">
                        <input type="text" class="form-control" id="inputSearch" placeholder="Location name" on-keyup="onKeyPress" />
                    </div>
                </div>
            </div>

            <div id="searchingLabel" style="display:none">
              <span class="label label-success"><i class="fa fa-spinner fa-spin"></i> Searching</span>
            </div>

            <div id="resultList"></div>

            <h4 style="margin-top:30px">History</h4>
            <div id="savedLocationsTable"></div>
          </div> <!-- end body -->

          <div class="modal-footer" id="footer">

          </div>


        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is : 'dwr-select-location',

    ready : function() {
      this.searchTimer = -1;
      this.currentLocations = this.load();

      this.queryBounds = new google.maps.LatLngBounds(
          new google.maps.LatLng(31.116463, -125.649703),
          new google.maps.LatLng(42.279745, -113.838212)
      );
    },

    attached : function() {
      // stupid hack cause Safari is the new IE. :(
      var popup = $(this.$.popup).remove();
      $('body').append(popup);
      popup.modal({show: false}); // init modal
    },

    init : function(map) {
      this.map = map;
      //this.places = new google.maps.places.PlacesService(this.map);
      this.geocoder = new google.maps.Geocoder();
    },

    show : function() {
      this.renderCurrentLocations();
      $(this.$.popup).modal('show');
    },

    onKeyPress : function() {
      this.query = $(this.$.inputSearch).val();

      if( this.searchTimer != -1 ) clearTimeout(this.searchTimer);
      if( !this.query ) return;

      this.searchTimer = setTimeout(function(){
        this.query = $(this.$.inputSearch).val();
        this.searchTimer = -1;
        this.geocode();
      }.bind(this), 200);

      //this.places.textSearch({query: this.query, bounds: this.queryBounds}, this.gotResults.bind(this));
    },

    geocode : function() {
      console.log(this.queryBounds);
      this.geocoder.geocode({ 'address': this.query+' California', bounds: this.queryBounds}, this.geocodeResults.bind(this));
    },

    geocodeResults : function(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
        this.gotResults(results);
      } else {
        alert("Geocode was not successful for the following reason: " + status);
      }
    },

    gotResults: function(results) {
      this.results = [];

      for( var i = 0; i < results.length; i++ ) {
        this.results.push({
          name : results[i].name,
          address : results[i].formatted_address,
          latitude: results[i].geometry.location.lat(),
          longitude: results[i].geometry.location.lng(),
        });
      }

      if( this.results.length == 0 ) {
        this.$.resultList.innerText = 'No resuls found for "'+this.query+'"';
        return;
      }

      var list = '<ul style="list-style:none">';
      for( var i = 0; i < this.results.length; i++ ) {
        var result = this.results[i];
        list += '<li><a index="'+i+'" style="cursor:pointer">'+result.address+'</a></li>';
      }
      this.$.resultList.innerHTML = list+'</ul>';

      $(this.$.resultList)
        .find('a')
        .on('click', function(e){
          var index = parseInt(e.currentTarget.getAttribute('index'));

          this.$.inputSearch.value = '';
          this.$.resultList.innerHTML = '';

          this.currentLocations.push(this.results[index]);
          this.fire('location-select', this.results[index]);
          $(this.$.popup).modal('hide');
          this.save();
        }.bind(this));
    },

    save : function() {
      if( !window.localStorage ) return;
      window.localStorage.setItem('cimis-history', JSON.stringify(this.currentLocations));
    },

    load : function() {
      if( !window.localStorage ) return [];
      var history = window.localStorage.getItem('cimis-history');
      if( !history ) return [];
      return JSON.parse(history);
    },

    renderCurrentLocations : function() {
      if( this.currentLocations.length == 0 ) {
        this.$.savedLocationsTable.innerText = 'None';
        return;
      }

      var table = '<table class="table">';
      for( var i = 0; i < this.currentLocations.length; i++ ) {
        var l = this.currentLocations[i];

        table += '<tr >'+
                '<td>'+
                    '<a style="cursor:pointer" goto index="'+i+'"><i class="fa fa-map-marker"></i> '+l.address+'</a>'+
                '</td>'+
                '<td>'+
                    '<a class="btn btn-link" trash index="'+i+'" ><i class="fa fa-trash"></i></a>'+
                '</td>'+
            '</tr>';
      }

      var ele = $(this.$.savedLocationsTable).html(table+'</table>')

      ele
        .find('a[trash]')
        .on('click', function(e){
          var index = parseInt(e.currentTarget.getAttribute('index'));
          this.currentLocations.splice(index, 1);
          this.renderCurrentLocations();
          this.save();
        }.bind(this));

      ele
        .find('a[goto]')
        .on('click', function(e){
          var index = parseInt(e.currentTarget.getAttribute('index'));
          this.fire('location-select', this.currentLocations[index]);
          $(this.$.popup).modal('hide');
        }.bind(this));

    },

    geolocate : function() {
      if( this.geolocating ) return;
      this.setLocating(true);

      if ( navigator.geolocation ) {
        navigator.geolocation.getCurrentPosition(this.onGeolocate.bind(this));
      } else {
        this.setLocating(false);
        alert("Geolocation is not supported by this browser.  Sorry :(");
      }
    },

    onGeolocate : function(position) {
      this.fire('location-select', position.coords);
      this.setLocating(false);
      $(this.$.popup).modal('hide');
    },

    setLocating : function(locating) {
      this.geolocating = locating;
      if( locating ) {
        this.$.geolocate.setAttribute('disabled', '');
        this.$.geolocate.innerHTML = '<i class="fa fa-crosshairs fa-spin"></i> Geolocating...';
      } else {
        this.$.geolocate.removeAttribute('disabled');
        this.$.geolocate.innerHTML = '<i class="fa fa-crosshairs"></i> Geolocate';
      }
    }

  })

</script>
