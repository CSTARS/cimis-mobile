<link rel="import" href="../components/core-scaffold/core-scaffold.html">
<link rel="import" href="../components/core-toolbar/core-toolbar.html">
<link rel="import" href="../components/core-menu/core-menu.html">
<link rel="import" href="../components/core-item/core-item.html">
<link rel="import" href="../components/paper-tabs/paper-tabs.html">
<link rel="import" href="../components/core-icons/maps-icons.html">
<link rel="import" href="../components/core-pages/core-pages.html">
<link rel="import" href="../components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="../components/core-animated-pages/transitions/slide-from-right.html">
<link rel="import" href="pages/dwr-page-hourly.html">
<link rel="import" href="pages/dwr-page-now.html">
<link rel="import" href="pages/dwr-page-settings.html">
<link rel="import" href="pages/dwr-page-map.html">
<link rel="import" href="ui/dwr-select-location.html">

<polymer-element name="dwr-app">
	<template>
        <style>
            :host {
                display: block;
                height: 100%;
            }
            core-item {
                color: #888;
            }
            core-item.core-selected {
                color: #333;
            }
            core-menu > core-item.core-selected {
                background-color: #eee;
                border-radius: 4px;
            }
            .full-height {
                width: 100%;
                height: 100%;
                display: block;
                position: absolute;
                top: 0px;
                left: 0px;
            }
            @media( max-width: 640px ) {
                paper-tab.core-selected {
                    background-color: transparent !important;
                }
                core-pages {
                    margin-top: 65px;
                }
            }
        </style>

		<core-scaffold id="scaffold" responsiveWidth="992px">
        	<core-header-panel navigation flex mode="seamed">
            	<core-toolbar>DWR Mobile App</core-toolbar>
            	<core-menu selected="{{selected}}" selectedItem="{{selectedItem}}">
                    <core-item icon="today" label="Now"></core-item>
                    <core-item icon="view-list" label="Hourly"></core-item>
                    <core-item icon="maps:map" label="Map"></core-item>
                    <core-item icon="settings" label="Settings"></core-item>
                </core-menu>
            </core-header-panel>

            <div tool style="width:100%" >
                <div layout horizontal>
                    <div flex>
                        <template bind if="{{showTabs && !phoneScreen}}">
                            <paper-tabs selected="{{selected}}" style="margin: -10px 0">
                                <paper-tab>Now</paper-tab>
                                <paper-tab>Hourly</paper-tab>
                            </paper-tabs>
                        </template>

                        <dwr-map-search hidden?="{{page != 'map'}}" phone="{{phoneScreen}}" on-search="{{_searchMap}}"></dwr-map-search>
                    </div>
                    <div>
                        <dwr-select-location map="{{gmap}}" location="{{location}}"></dwr-select-location>
                    </div>
                </div>
            </div>

            <core-media-query query="max-width: 640px" queryMatches="{{phoneScreen}}"></core-media-query>

            <div class="full-height">
                <div vertical layout style="height:100%">
                    <div>
                        <template bind if="{{phoneScreen && showTabs}}">
                            <paper-tabs selected="{{selected}}">
                                <paper-tab>Now</paper-tab>
                                <paper-tab>Hourly</paper-tab>
                            </paper-tabs>
                        </template>
                    </div>
                    <div flex style="position:relative">

                        <core-animated-pages id="pages" selected="{{selected}}" transitions="slide-from-right" class="full-height">
                            <dwr-page-now id="now"></dwr-page-now>
                            <dwr-page-hourly id="hourly"></dwr-page-hourly>
                            <dwr-page-map id="map" map="{{gmap}}" location="{{location}}"></dwr-page-map>
                            <dwr-page-settings id="settings"></dwr-page-settings>
                        </core-animated-pages>
                    </div>
                </div>
            </div>

        </core-scaffold>
	</template>
	<script>
		Polymer('dwr-app', {
            selected : 0,
            selectedItem : {},

            // current page we are on
            page : '',

            // google map object
            gmap : null,
            // current location
            location: null,

            phoneScreen : false,

            // show tabs
            showTabs : true,

            observe : {
                selected : '_updatePage'
            },

            ready : function() {
                var hash = window.location.hash || '';
                hash = hash.replace(/#/,'');
                if( hash == '' ) return;

                for( var i = 0; i < this.$.pages.children.length; i++ ) {
                    if( this.$.pages.children[i].id == hash ) {
                        this.selected = i;
                        break;
                    }
                }
            },

            _updatePage : function() {
                this.async(function(){
                    this.page = this.selectedItem.label.toLowerCase();

                    if( this.page == 'settings' || this.page == 'map' ) {
                        this.showTabs = false;
                    } else {
                        this.showTabs = true;
                    }

                    if( this.$[this.page] && this.$[this.page].onShow ) {
                        this.$[this.page].onShow();
                    }

                    window.location.hash = this.page;
                    this.$.scaffold.closeDrawer();
                });
            },

            // wire up header text map with map page
            _searchMap : function(e) {
                this.$.map.search(e.detail);
            }

		});
	</script>
</polymer-element>