<dom-module id="dwr-page-map">
  <style>
    :host {
      display: block;
      height: 100%;
    }
  </style>

  <template>
    <div id="map" style="height: 100%"></div>
  </template>

</dom-module>

<script>
  Polymer({

    is : 'dwr-page-map',

    ready : function() {
      this.cache = {};

      var mapOptions = {
        center: { lat: 35.033291, lng: -120.961762},
        zoom: 8
      };
      this.map = new google.maps.Map(this.$.map, mapOptions);

      google.maps.event.addListener(this.map, 'click', this.onMapClick.bind(this));

      var bounds = CIMIS.bounds();
      bounds = new google.maps.LatLngBounds(
          new google.maps.LatLng(bounds[0][1], bounds[0][0]),
          new google.maps.LatLng(bounds[1][1], bounds[1][0])
      );

      var rectangle = new google.maps.Rectangle({bounds: bounds});
      //rectangle.setMap(this.map);
    },

    onMapClick : function(e) {
      if( this.rectangle ) this.rectangle.setMap(null);

      this.grid = CIMIS.llToGrid(e.latLng);
      this.cid = this.grid.row+'-'+this.grid.col;

      var bounds = new google.maps.LatLngBounds(
          new google.maps.LatLng(this.grid.bottomLeft[1], this.grid.bottomLeft[0]),
          new google.maps.LatLng(this.grid.topRight[1], this.grid.topRight[0])
      );

      this.rectangle = new google.maps.Rectangle({bounds: bounds});
      this.rectangle.setMap(this.map);


      if( this.cache[this.cid] ) {
        this.fireLocationUpdate();
      } else {
        $.get('https://cimis-mobile.firebaseio.com/'+this.cid+'/.json', function(resp){
          this.cache[this.cid] = resp;
          this.fireLocationUpdate();
        }.bind(this));
      }

    },

    fireLocationUpdate : function() {
      this.fire('location-update', {
        data: this.cache[this.cid],
        grid : this.grid
      });
    },

    onShow : function() {
        if( !window.google ) return;
        google.maps.event.trigger(this.$.map, 'resize');
    }
  });
</script>
