{"changed":true,"filter":false,"title":"load2redis.js","tooltip":"/tools/load2redis.js","value":"#! /usr/bin/node\n\nvar flatconfig = require('flatconfig');\nvar path=require('path');\nvar Tunnel=require(\"tunnel-ssh\");\nvar async=require(\"async\");\nvar http = require('http');\nvar Zlib = require('zlibjs');\n\n// Load the configuration\nvar args = flatconfig.parseArgs(process.argv.slice(2));\nvar config = flatconfig.loadConfig(\n              path.resolve(process.env.HOME, 'cimis.json'), \n              path.resolve(process.cwd(), args['config']),\n              args);\n\nconsole.log(config);\n\n//var tunnel = new Tunnel(config.redis);\n//tunnel.connect(function (error) {\n//    console.log(error);\n    //or start your remote connection here .... \n    //mongoose.connect(...);\n    \n\n    //close tunnel to exit script \n//    tunnel.close();\n//});\n\nvar parms=[\"ETo\",\"K\",\"Rnl\",\"Rso\",\"Tdew\",\"Tn\",\"Tx\",\"U2\"];\n\n//var pixels={\n//    \"3400:1220\" : {\"ETo\":12,\"K\":30,\"Rnl\":34.8,\"Rso\":34.9,\"Tn\":12.4,\"Tx\":34.4,\"U2\":4.1},\n//};\n\n\n// Foreach parameter in parms\nasync.eachSeries(parms,\n    function(parm, next){\n        var url=config.cimis.base+'/'+config.date+'/'+parm+'.asc.gz';\n        // fetch $cimis/$date/${parm}.asc.gz\n        uncompress(url,function(ascii){\n            addParameter(parm,ascii);\n            next();\n        });\n    },\n    function(err){\n        console.log('done');\n    }\n);\n    \n    \nfunction verify_header(ascii) {\n    // Read \n}\n\nfunction addParameter(parm,ascii) {\n            // If the data is not there, fail with notice of missing file\n            // Otherwise\n            var header=verify_header(ascii);\n            \n            var kvp ={};\n            var row,v,value;\n            var r,c;\n            \n            for ( r=0; r<=header.rows; r++) {\n                var values = row.split(' ');\n                for (c=0; c<=header.cols; c++) {\n                    var pixel_value=values[c];\n                    if (v != header.no_data ) {\n                      var key= ((r*2000+header.start)/1000) + ':' + (c*2000+header.ul);\n                      var kv = kvp[key] || {};\n                      kv[parm]=pixel_value;\n                      kvp[key]=kv;\n                    }\n                }\n            }\n}\n\n// Zipcode - Should we make this on our end, or get from server? \n// I like let's try making it on our own, in that case we don't have to \n","undoManager":{"mark":99,"position":100,"stack":[[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":83,"column":4},"end":{"row":83,"column":5}},"text":"r"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":83,"column":3},"end":{"row":83,"column":4}},"text":"o"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":83,"column":2},"end":{"row":83,"column":3}},"text":"p"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":83,"column":1},"end":{"row":83,"column":2}},"text":"x"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":83,"column":0},"end":{"row":83,"column":1}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"removeLines","range":{"start":{"row":85,"column":0},"end":{"row":96,"column":0}},"nl":"\n","lines":["    var req = new XMLHttpRequest();","    ","    // You gotta trick it into downloading binary.","    req.open('GET', request_url, false);","    req.overrideMimeType('text\\/plain; charset=x-user-defined');    ","    req.send(null);","    ","    // Check for any error....","    if (req.status != 200) {","        return '';","    }"]}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":83,"column":27},"end":{"row":83,"column":28}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":83,"column":26},"end":{"row":83,"column":27}},"text":"s"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":83,"column":25},"end":{"row":83,"column":26}},"text":"n"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":83,"column":24},"end":{"row":83,"column":25}},"text":"o"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":83,"column":23},"end":{"row":83,"column":24}},"text":"p"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":83,"column":22},"end":{"row":83,"column":23}},"text":"s"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":83,"column":22},"end":{"row":83,"column":23}},"text":"q"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":83,"column":20},"end":{"row":83,"column":23}},"text":"req"},{"action":"insertText","range":{"start":{"row":83,"column":20},"end":{"row":83,"column":23}},"text":"req"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":92,"column":4},"end":{"row":92,"column":5}},"text":"v"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":92,"column":5},"end":{"row":92,"column":6}},"text":"a"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":92,"column":6},"end":{"row":92,"column":7}},"text":"r"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":92,"column":7},"end":{"row":92,"column":8}},"text":" "}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":8,"column":0},"end":{"row":8,"column":1}},"text":"v"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":8,"column":1},"end":{"row":8,"column":2}},"text":"a"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":8,"column":2},"end":{"row":8,"column":3}},"text":"r"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":8,"column":3},"end":{"row":8,"column":4}},"text":" "}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":8,"column":4},"end":{"row":8,"column":5}},"text":"Z"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":8,"column":5},"end":{"row":8,"column":6}},"text":"l"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":8,"column":6},"end":{"row":8,"column":7}},"text":"i"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":8,"column":7},"end":{"row":8,"column":8}},"text":"b"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":8,"column":8},"end":{"row":8,"column":9}},"text":" "}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":8,"column":9},"end":{"row":8,"column":10}},"text":"="}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":8,"column":10},"end":{"row":8,"column":11}},"text":" "}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":8,"column":11},"end":{"row":8,"column":12}},"text":"r"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":8,"column":12},"end":{"row":8,"column":13}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":8,"column":13},"end":{"row":8,"column":14}},"text":"u"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":8,"column":14},"end":{"row":8,"column":15}},"text":"i"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":8,"column":14},"end":{"row":8,"column":15}},"text":"i"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":8,"column":13},"end":{"row":8,"column":14}},"text":"u"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":8,"column":13},"end":{"row":8,"column":14}},"text":"q"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":8,"column":14},"end":{"row":8,"column":15}},"text":"u"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":8,"column":15},"end":{"row":8,"column":16}},"text":"i"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":8,"column":16},"end":{"row":8,"column":17}},"text":"r"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":8,"column":17},"end":{"row":8,"column":18}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":8,"column":18},"end":{"row":8,"column":20}},"text":"()"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":8,"column":19},"end":{"row":8,"column":21}},"text":"''"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":8,"column":20},"end":{"row":8,"column":21}},"text":"z"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":8,"column":21},"end":{"row":8,"column":22}},"text":"l"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":8,"column":22},"end":{"row":8,"column":23}},"text":"i"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":8,"column":23},"end":{"row":8,"column":24}},"text":"b"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":8,"column":24},"end":{"row":8,"column":25}},"text":"j"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":8,"column":25},"end":{"row":8,"column":26}},"text":"s"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":8,"column":28},"end":{"row":8,"column":29}},"text":";"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":2,"column":0},"end":{"row":2,"column":49}},"text":"var asciiLoader = require(\"loadCompressedAscii\");"}]}],[{"group":"doc","deltas":[{"action":"removeLines","range":{"start":{"row":1,"column":0},"end":{"row":2,"column":0}},"nl":"\n","lines":[""]}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":41,"column":42},"end":{"row":41,"column":43}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":41,"column":41},"end":{"row":41,"column":42}},"text":"l"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":41,"column":40},"end":{"row":41,"column":41}},"text":"i"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":41,"column":39},"end":{"row":41,"column":40}},"text":"F"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":41,"column":38},"end":{"row":41,"column":39}},"text":"I"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":41,"column":37},"end":{"row":41,"column":38}},"text":"I"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":41,"column":36},"end":{"row":41,"column":37}},"text":"C"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":41,"column":35},"end":{"row":41,"column":36}},"text":"S"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":41,"column":34},"end":{"row":41,"column":35}},"text":"A"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":41,"column":33},"end":{"row":41,"column":34}},"text":"d"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":41,"column":32},"end":{"row":41,"column":33}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":41,"column":31},"end":{"row":41,"column":32}},"text":"s"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":41,"column":30},"end":{"row":41,"column":31}},"text":"s"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":41,"column":29},"end":{"row":41,"column":30}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":41,"column":28},"end":{"row":41,"column":29}},"text":"r"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":41,"column":27},"end":{"row":41,"column":28}},"text":"p"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":41,"column":26},"end":{"row":41,"column":27}},"text":"m"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":41,"column":25},"end":{"row":41,"column":26}},"text":"o"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":41,"column":24},"end":{"row":41,"column":25}},"text":"C"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":41,"column":23},"end":{"row":41,"column":24}},"text":"d"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":41,"column":22},"end":{"row":41,"column":23}},"text":"a"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":41,"column":21},"end":{"row":41,"column":22}},"text":"o"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":41,"column":20},"end":{"row":41,"column":21}},"text":"l"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":41,"column":19},"end":{"row":41,"column":20}},"text":"."}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":41,"column":18},"end":{"row":41,"column":19}},"text":"r"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":41,"column":17},"end":{"row":41,"column":18}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":41,"column":16},"end":{"row":41,"column":17}},"text":"d"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":41,"column":15},"end":{"row":41,"column":16}},"text":"a"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":41,"column":14},"end":{"row":41,"column":15}},"text":"o"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":41,"column":13},"end":{"row":41,"column":14}},"text":"L"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":41,"column":12},"end":{"row":41,"column":13}},"text":"i"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":41,"column":11},"end":{"row":41,"column":12}},"text":"i"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":41,"column":10},"end":{"row":41,"column":11}},"text":"c"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":41,"column":9},"end":{"row":41,"column":10}},"text":"s"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":41,"column":8},"end":{"row":41,"column":9}},"text":"a"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":41,"column":8},"end":{"row":41,"column":9}},"text":"u"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":41,"column":9},"end":{"row":41,"column":10}},"text":"n"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":41,"column":10},"end":{"row":41,"column":11}},"text":"c"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":41,"column":11},"end":{"row":41,"column":12}},"text":"o"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":41,"column":12},"end":{"row":41,"column":13}},"text":"m"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":41,"column":13},"end":{"row":41,"column":14}},"text":"p"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":41,"column":14},"end":{"row":41,"column":15}},"text":"r"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":41,"column":15},"end":{"row":41,"column":16}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":41,"column":16},"end":{"row":41,"column":17}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":41,"column":16},"end":{"row":41,"column":17}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":41,"column":16},"end":{"row":41,"column":17}},"text":"s"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":41,"column":17},"end":{"row":41,"column":18}},"text":"s"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":113,"column":0},"end":{"row":113,"column":1}},"text":"}"},{"action":"removeLines","range":{"start":{"row":82,"column":0},"end":{"row":113,"column":0}},"nl":"\n","lines":["function uncompress(req) {","","","    // Here's our raw binary.","    var rawfile = req.responseText;","","    // Ok you gotta walk all the characters here, to remove the high-order values.","","    // Create a byte array.","    var bytes = [];","","    // Walk through each character in the stream.","    for (var fileidx = 0; fileidx < rawfile.length; fileidx++) {","        var abyte = rawfile.charCodeAt(fileidx) & 0xff;","        bytes.push(abyte);","    }","","    // Instantiate our zlib object, and gunzip it.    ","    // Requires: https://github.com/imaya/zlib.js/blob/master/bin/gunzip.min.js","    // (remove the map instruction at the very end.)","    var  gunzip  =  new  Zlib.Gunzip ( bytes ); ","    var  plain  =  gunzip.decompress ();","","    // Now go ahead and create an ascii string from all those bytes.","    // Seeing we've just got a big ole byte buffer, but, not an ASCII file.","    var asciistring = \"\";","    for (var i = 0; i < plain.length; i++) {","        asciistring += String.fromCharCode(plain[i]);","    }","","    return asciistring;"]}]}],[{"group":"doc","deltas":[{"action":"removeLines","range":{"start":{"row":81,"column":0},"end":{"row":82,"column":0}},"nl":"\n","lines":[""]}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":55,"column":0},"end":{"row":55,"column":4}},"text":"    "}]}],[{"group":"doc","deltas":[{"action":"removeLines","range":{"start":{"row":65,"column":0},"end":{"row":77,"column":0}},"nl":"\n","lines":["            for ( r=0; r<=header.rows; r++) {","                var values = row.split(' ');","                for (c=0; c<=header.cols; c++) {","                    var pixel_value=values[c];","                    if (v != header.no_data ) {","                      var key= ((r*2000+header.start)/1000) + ':' + (c*2000+header.ul);","                      var kv = kvp[key] || {};","                      kv[parm]=pixel_value;","                      kvp[key]=kv;","                    }","                }","            }"]},{"action":"insertText","range":{"start":{"row":65,"column":0},"end":{"row":65,"column":1}},"text":"w"}]}]]},"ace":{"folds":[],"scrolltop":739,"scrollleft":0,"selection":{"start":{"row":77,"column":0},"end":{"row":77,"column":0},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":40,"state":"start","mode":"ace/mode/javascript"}},"timestamp":1411781082790}